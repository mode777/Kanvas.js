/*! For license information please see example_ink.js.LICENSE.txt */
!function(){var t={802:function(t,e,n){"use strict";n.r(e),e.default={inkVersion:20,root:[[{"#":"author: Wolfgang Ecke"},{"#":"title: Der Bildband"},"^@(KNÖDLER set img:women_02 name:'Frau Knödler' flipped:true)","\n","^@(SCHATZ set img:man_08 name:'Herr Schatz')","\n","^@(title show time:3000)","\n","^@(wait time:3000)","\n","^@(title hide time:4000) @(scene fade-in img:bg_lib time:4000)","\n","^VOICEOVER: Als Frau Knödler den Verlust bemerkte, war es wenige Minuten vor Ladenschluss. Überraschung und Verständnislosigkeit hielten sich zunächst die Waage.","\n","^VOICEOVER: Doch je länger sie über das Geschehnis nachdachte, umso mehr geriet sie in eine Stimmung, die man allgemein als ,gerechten Zorn‘ bezeichnet.","\n","^VOICEOVER: Und Amanda Knödler, Inhaberin der Bücherei am Kaisereck, rief Herrn Schatz an. Franz Schatz war nicht nur ihr Untermieter, sondern auch Detektiv in einer Versicherung.","\n","^@(KNÖDLER enter pos:left)","\n","^@(SCHATZ enter pos:right)","\n","ev","str","^Beruhigen","/str","/ev",{"*":"0.c-0",flg:20},{"c-0":["^ SCHATZ: Nur immer der Reihe nach, Frau Knödler! Also, wie war das?","\n",{"->":"0.g-0"},{"#f":5}],"g-0":["^KNÖDLER: Ich hatte den Bildband gerade ausgepackt und dort drüben ins Regal gestellt.","\n","ev","str","^Andere Kunden?","/str","/ev",{"*":".^.c-1",flg:20},{"c-1":["^ SCHATZ: Wer war außer ihnen noch im Laden?","\n",{"->":"0.g-1"},{"#f":5}]}],"g-1":["^KNÖDLER: Im Laden waren nur zwei Kunden: Frau Stolze und Herr Langbein. Beide leihen seit Jahren aus. Sie sind sozusagen Stammkunden meiner Leihbuchabteilung … ",{"->":"questions"},"\n",["done",{"#n":"g-2"}],null]}],"done",{questions:[["ev","str","^Ausgeliehen?","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Verstecken?","/str","/ev",{"*":".^.c-1",flg:20},"ev","str","^Weitere Kunden?","/str","/ev",{"*":".^.c-2",flg:20},"ev","str","^Verlassen?","/str","/ev",{"*":".^.c-3",flg:20},{"*":".^.c-4",flg:24},{"c-0":["^ SCHATZ: Haben die beiden auch heute ausgeliehen?","\n","^KNÖDLER: Ja. Herr Langbein zwei Kriminalromane und Frau Stolze ein Buch über Astrologie.","\n","^KNÖDLER: Ich musste es ihr heraussuchen, weil sie ihre Brille vergessen hatte. Sie ist ja so kurzsichtig, dass sie nicht einmal ein Fünfmarkstück in ihrer Hand erkennen kann.","\n","^KNÖDLER: Gerade als ich ihr das Buch gab, klingelte das Telefon …","\n",{"->":".^.^.g-0"},{"#f":5}],"c-1":["^ SCHATZ: Hatten die beiden Herrschaften denn die Möglichkeit, den Bildband unterzubringen?","\n","^KNÖDLER: Ja. Frau Stolze trug eine größere Einkaufstasche, und Herr Langbein …","\n","^KNÖDLER: …ja, Herr Langbein hatte eine Aktenmappe bei sich.","\n",{"->":".^.^.g-0"},{"#f":5}],"c-2":["^ SCHATZ: Kamen nach den beiden noch andere Kunden?","\n","^KNÖDLER: Nein, sie waren die einizgen zu der Zeit","\n",["ev","str","^Bildband","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["^ SCHATZ: Und als die beiden gegangen waren fehlte auch der Bildband?","\n","^KNÖDLER: So war es!","\n",{"->":".^.^.^.^.g-0"},{"#f":5}]}],{"#f":5}],"c-3":["^ SCHATZ: Wer verließ den Laden zuerst?","\n","^KNÖDLER: Zuerst ging Herr Langbein …","\n",{"->":".^.^.g-0"},{"#f":5}],"c-4":["\n","^SCHATZ: Na schön. Dann geben Sie mir mal jetzt die Adressen der beiden Stammkunden. Mal sehen, was sie zu sagen haben.","\n",{"->":"interog"},{"->":".^.^.g-0"},{"#f":5}],"g-0":[{"->":".^.^.^"},null]}],null],interog:[["^@(characters exit)","\n","^@(scene fade_out)","\n","^@(scene fade_in img:bg_map)","\n","ev","str","^Herr Langbein @(pin x:0.3 y:0.3)","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Frau Stolze @(pin x:0.6 y:0.6)","/str","/ev",{"*":".^.c-1",flg:20},"ev","str","^Auflösen","/str",{"CNT?":"langbein"},{"CNT?":"stolze"},"&&","/ev",{"*":".^.c-2",flg:21},{"c-0":["^ ",{"->":"langbein"},"\n",{"#f":5}],"c-1":["^ ",{"->":"stolze"},"\n",{"#f":5}],"c-2":["^ SCHATZ: Meine Mission ist erfüllt. Ich sollte mich ja nur erkundigen … ","\n",{"->":"solution"},{"#f":5}]}],null],langbein:[["^VOICEOVER: Herr Langbein blickte misstrauisch durch den Türschlitz","\n","^LANGBEIN: Was wollen sie?","\n","ev","str","^Vorstellen","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["^ SCHATZ: Ich würde gern einmal eintreten, Herr Langbein. Frau Knödler von der Bücherei schickt mich","\n",{"->":".^.^.g-0"},{"#f":5}],"g-0":["^LANGBEIN: Bitte, nehmen Sie Platz. Was hat Frau Knödler denn auf dem Herzen? ",{"->":".^.^.^.questions"},"\n",null]}],{questions:[["ev","str","^Kunde","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Aufgefallen?","/str","/ev",{"*":".^.c-1",flg:4},"ev","str","^Bildband","/str","/ev",{"*":".^.c-2",flg:20},{"c-0":["^ SCHATZ: Sie sind, wie mir Frau Knödler sagte, ein langjähriger Kunde …","\n","^LANGBEIN: Bin ich …","\n",{"->":".^.^.g-0"},{"#f":5}],"c-1":["^ SCHATZ: Ist Ihnen ",["ev","visit",1,"MIN","/ev","ev","du",0,"==","/ev",{"->":".^.s0",c:!0},"ev","du",1,"==","/ev",{"->":".^.s1",c:!0},"nop",{s0:["pop",{"->":".^.^.17"},null],s1:["pop","^vielleicht doch noch",{"->":".^.^.17"},null],"#f":5}],"^ etwas aufgefallen?","\n","ev",{"VAR?":"knows"},"!","/ev",[{"->":".^.b",c:!0},{b:["^ LANGBEIN: ",["ev","visit",1,"MIN","/ev","ev","du",0,"==","/ev",{"->":".^.s0",c:!0},"ev","du",1,"==","/ev",{"->":".^.s1",c:!0},"nop",{s0:["pop","^Nicht das ich wüsste. Worum geht es denn bitte? ",{"->":".^.^.17"},null],s1:["pop","^ Wie gesagt: Generell ist mir nichts besonderes aufgefallen. ",{"->":".^.^.17"},null],"#f":5}],"^ ",{"->":".^.^.^.9"},null]}],"nop","\n","ev",{"VAR?":"knows"},"/ev",[{"->":".^.b",c:!0},{b:["^ Verstehe. Sie wollen wissen, ob ich den Bildband gestohlen habe … Ich war es selbstverständlich nicht. Aber vielleicht sehen Sie sich einmal die Frau an, die mit mir im Laden war … Und jetzt darf ich Sie bitten zu gehen! ",{"->":"interog"},{"->":".^.^.^.15"},null]}],"nop","\n",{"->":".^.^.g-0"},null],"c-2":["^ SCHATZ: Frau Knödler hat heute Nachmittag einen kostbaren Bildband, Wert hundertzwanzig Mark, ins Regal gestellt. Der ist verschwunden! ","\n","^LANGBEIN: … doch nicht etwa der dicke Bildband mit den antiken Ausgrabungen …?“","\n","^SCHATZ: Genau der!","\n","ev",1,"/ev",{"VAR=":"knows",re:!0},{"->":".^.^.g-0"},{"#f":5}],"g-0":[{"->":".^.^.^"},null]}],null],"#f":1}],stolze:["ev",{"CNT?":"langbein"},"/ev",[{"->":".^.b",c:!0},{b:["^ Frau Stolze gab sich wesentlich freundlicher Sie bot Schatz sogar ein Glas Bier an. ",{"->":"stolze.5"},null]}],[{"->":".^.b"},{b:["^ Frau Stolze war sehr freundlich und bot Schatz ein Glas Bier an. ",{"->":"stolze.5"},null]}],"nop","^ ",{"->":".^.questions"},"\n",{questions:[["ev","str","^Aufgefallen?","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Bildband","/str","/ev",{"*":".^.c-1",flg:20},{"*":".^.c-2",flg:24},{"c-0":["^ SCHATZ: Ist Ihnen heute in der Buchhandlung etwas aufgefallen?","\n","^STOLZE: Ich habe was beobachtet","\n","^STOLZE: … Da war noch ein Mann im Laden …","\n","^STOLZE: ich stand einige Meter weg ... Er wusste nicht, dass ich ihn sehe","\n","^STOLZE: … und dieser Mann blätterte in einem dicken Buch, wo draufstand ,Antike Ausgrabungen‘.”","\n",["ev","str","^Gesehen","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["^ SCHATZ: Haben Sie auch gesehen, dass er es eingesteckt hat?","\n","^STOLZE: Nein, das habe ich nicht gesehen","\n",{"->":".^.^.^.^.g-0"},{"#f":5}]}],{"#f":5}],"c-1":["^ SCHATZ: Frau Knödler hat heute Nachmittag einen kostbaren Bildband, Wert hundertzwanzig Mark, ins Regal gestellt. Der ist verschwunden! ","\n","^STOLZE: Ich soll den Bildband mitgenommen haben? Nein, lieber Herr, da irren Sie sich.","\n",{"->":".^.^.g-0"},{"#f":5}],"c-2":["\n","^STOLZE: Haben sie mich jetzt nicht mehr im Verdacht?","\n","^SCHATZ: Sicher werden Sie noch von der Sache hören, Frau Stolze. ",{"->":"interog"},"\n",{"->":".^.^.g-0"},{"#f":5}],"g-0":[{"->":".^.^.^"},null]}],null],"#f":1}],solution:[["^VOICEOVER: Eine halbe Stunde später stand Herr Schatz wieder seiner Wirtin gegenüber. Und Frau Knödler war ehrlich erfreut, dass der Ausflug ihres Untermieters von Erfolg gewesen war. Und sie nahm sich vor, mit der diebischen Person ein ernstes Wörtchen zu reden.","\n","^VOICEOVER: Wer stahl den Bildband nun wirklich?","\n",["end",{"#n":"g-0"}],null],null],"global decl":["ev",0,{"VAR=":"knows"},"/ev","end",null]}],listDefs:{}}},117:function(t,e){!function(t){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function r(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&o(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function l(t,e,n){return(l=u()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&o(r,n.prototype),r}).apply(null,arguments)}function h(t){var e="function"==typeof Map?new Map:void 0;return(h=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return l(t,arguments,s(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),o(i,t)})(t)}function c(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function f(t){var e=u();return function(){var n,i=s(t);if(e){var r=s(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return c(this,n)}}function v(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,r,a=[],s=!0,o=!1;try{for(n=n.call(t);!(s=(i=n.next()).done)&&(a.push(i.value),!e||a.length!==e);s=!0);}catch(t){o=!0,r=t}finally{try{s||null==n.return||n.return()}finally{if(o)throw r}}return a}}(t,e)||p(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(t){return function(t){if(Array.isArray(t))return y(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||p(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t,e){if(t){if("string"==typeof t)return y(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?y(t,e):void 0}}function y(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function m(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=p(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){o=!0,a=t},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}var g,S=function(){function t(){if(n(this,t),this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){var e=arguments[0];this.componentsString=e}else if(arguments[0]instanceof t.Component&&arguments[1]instanceof t){var i=arguments[0],r=arguments[1];this._components.push(i),this._components=this._components.concat(r._components)}else if(arguments[0]instanceof Array){var a=arguments[0],s=!!arguments[1];this._components=this._components.concat(a),this._isRelative=s}}return r(t,[{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return this._components.length>0?this._components[0]:null}},{key:"tail",get:function(){return this._components.length>=2?new t(this._components.slice(1,this._components.length)):t.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var t=this._components.length-1;return t>=0?this._components[t]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}},{key:"GetComponent",value:function(t){return this._components[t]}},{key:"PathByAppendingPath",value:function(e){for(var n=new t,i=0,r=0;r<e._components.length&&e._components[r].isParent;++r)i++;for(var a=0;a<this._components.length-i;++a)n._components.push(this._components[a]);for(var s=i;s<e._components.length;++s)n._components.push(e._components[s]);return n}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(e){if(this._components.length=0,this._componentsString=e,null!=this._componentsString&&""!=this._componentsString){"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));var n,i=m(this._componentsString.split("."));try{for(i.s();!(n=i.n()).done;){var r=n.value;/^(\-|\+)?([0-9]+|Infinity)$/.test(r)?this._components.push(new t.Component(parseInt(r))):this._components.push(new t.Component(r))}}catch(t){i.e(t)}finally{i.f()}}}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(e){var n,i=new t;return(n=i._components).push.apply(n,d(this._components)),i._components.push(e),i}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}();function b(t,e){return t instanceof e?E(t):null}function w(t,e){if(t instanceof e)return E(t);throw new Error("".concat(t," is not of type ").concat(e))}function k(t){return t.hasValidName&&t.name?t:null}function C(t){return void 0===t?null:t}function _(t){return"object"===e(t)&&"function"==typeof t.Equals}function E(t,e){return t}S.parentId="^",function(t){var e=function(){function e(t){n(this,e),this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}return r(e,[{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==t.parentId}},{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}],[{key:"ToParent",value:function(){return new e(t.parentId)}}]),e}();t.Component=e}(S||(S={})),function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}t.AssertType=function(t,n,i){e(t instanceof n,i)},t.Assert=e}(g||(g={}));var T=function(t){a(i,t);var e=f(i);function i(){return n(this,i),e.apply(this,arguments)}return r(i)}(h(Error));function O(t){throw new T("".concat(t," is null or undefined"))}var P=function(){function t(){n(this,t),this.parent=null,this._debugMetadata=null,this._path=null}return r(t,[{key:"debugMetadata",get:function(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata},set:function(t){this._debugMetadata=t}},{key:"ownDebugMetadata",get:function(){return this._debugMetadata}},{key:"DebugLineNumberOfPath",value:function(t){if(null===t)return null;var e=this.rootContentContainer;if(e){var n=e.ContentAtPath(t).obj;if(n){var i=n.debugMetadata;if(null!==i)return i.startLineNumber}}return null}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new S;else{for(var t=[],e=this,n=b(e.parent,U);null!==n;){var i=k(e);if(null!=i&&i.hasValidName){if(null===i.name)return O("namedChild.name");t.unshift(new S.Component(i.name))}else t.unshift(new S.Component(n.content.indexOf(e)));e=n,n=b(n.parent,U)}this._path=new S(t)}return this._path}},{key:"ResolvePath",value:function(t){if(null===t)return O("path");if(t.isRelative){var e=b(this,U);return null===e&&(g.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=b(this.parent,U),g.Assert(null!==e,"Expected parent to be a container"),g.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?O("nearestContainer"):e.ContentAtPath(t)}var n=this.rootContentContainer;return null===n?O("contentContainer"):n.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.length,e.length),i=-1,r=0;r<n;++r){var a=e.GetComponent(r),s=t.GetComponent(r);if(!a.Equals(s))break;i=r}if(-1==i)return t;for(var o=e.componentCount-1-i,u=[],l=0;l<o;++l)u.push(S.Component.ToParent());for(var h=i+1;h<t.componentCount;++h)u.push(t.GetComponent(h));return new S(u,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return b(t,U)}},{key:"Copy",value:function(){throw Error("Not Implemented: Doesn't support copying")}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"Equals",value:function(t){return t===this}}]),t}(),A=function(){function t(e){n(this,t),e=void 0!==e?e.toString():"",this.string=e}return r(t,[{key:"Length",get:function(){return this.string.length}},{key:"Append",value:function(t){null!==t&&(this.string+=t)}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this.string+="\n"}},{key:"AppendFormat",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,(function(t,e){return void 0!==n[e]?n[e]:t}))}},{key:"toString",value:function(){return this.string}}]),t}(),x=function(){function t(){if(n(this,t),this.originName=null,this.itemName=null,void 0!==arguments[1]){var e=arguments[0],i=arguments[1];this.originName=e,this.itemName=i}else if(arguments[0]){var r=arguments[0].toString().split(".");this.originName=r[0],this.itemName=r[1]}}return r(t,[{key:"isNull",get:function(){return null==this.originName&&null==this.itemName}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}},{key:"toString",value:function(){return this.fullName}},{key:"Equals",value:function(e){if(e instanceof t){var n=e;return n.itemName==this.itemName&&n.originName==this.originName}return!1}},{key:"copy",value:function(){return new t(this.originName,this.itemName)}},{key:"serialized",value:function(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}}],[{key:"Null",get:function(){return new t(null,null)}},{key:"fromSerializedKey",value:function(e){var n=JSON.parse(e);if(!t.isLikeInkListItem(n))return t.Null;var i=n;return new t(i.originName,i.itemName)}},{key:"isLikeInkListItem",value:function(t){return!("object"!==e(t)||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==typeof t.originName||"string"!=typeof t.itemName&&null!==typeof t.itemName)}}]),t}(),N=function(t){a(s,t);var i=f(s);function s(){var t,r=arguments;if(n(this,s),(t=i.call(this,r[0]instanceof s?r[0]:[])).origins=null,t._originNames=[],arguments[0]instanceof s){var a=arguments[0];t._originNames=a.originNames,null!==a.origins&&(t.origins=a.origins.slice())}else if("string"==typeof arguments[0]){var o=arguments[0],u=arguments[1];if(t.SetInitialOriginName(o),null===u.listDefinitions)return c(t,O("originStory.listDefinitions"));var l=u.listDefinitions.TryListGetDefinition(o,null);if(!l.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+o);if(null===l.result)return c(t,O("def.result"));t.origins=[l.result]}else if("object"===e(arguments[0])&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){var h=arguments[0];t.Add(h.Key,h.Value)}return t}return r(s,[{key:"AddItem",value:function(t){if(t instanceof x){var e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return O("this.origins");var n,i=m(this.origins);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r.name==e.originName){var a=r.TryGetValueForItem(e,0);if(a.exists)return void this.Add(e,a.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}}}catch(t){i.e(t)}finally{i.f()}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}var s=t,o=null;if(null===this.origins)return O("this.origins");var u,l=m(this.origins);try{for(l.s();!(u=l.n()).done;){var h=u.value;if(null===s)return O("itemName");if(h.ContainsItemWithName(s)){if(null!=o)throw new Error("Could not add the item "+s+" to this list because it could come from either "+h.name+" or "+o.name);o=h}}}catch(t){l.e(t)}finally{l.f()}if(null==o)throw new Error("Could not add the item "+s+" to this list because it isn't known to any list definitions previously associated with this list.");var c=new x(o.name,s),f=o.ValueForItem(c);this.Add(c,f)}},{key:"ContainsItemNamed",value:function(t){var e,n=m(this);try{for(n.s();!(e=n.n()).done;){var i=v(e.value,1)[0];if(x.fromSerializedKey(i).itemName==t)return!0}}catch(t){n.e(t)}finally{n.f()}return!1}},{key:"ContainsKey",value:function(t){return this.has(t.serialized())}},{key:"Add",value:function(t,e){var n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(t));this.set(n,e)}},{key:"Remove",value:function(t){return this.delete(t.serialized())}},{key:"Count",get:function(){return this.size}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var t=this.maxItem.Key.originName,e=null;return this.origins.every((function(n){return n.name!=t||(e=n,!1)})),e}},{key:"originNames",get:function(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);var t,e=m(this);try{for(e.s();!(t=e.n()).done;){var n=v(t.value,1)[0],i=x.fromSerializedKey(n);if(null===i.originName)return O("item.originName");this._originNames.push(i.originName)}}catch(t){e.e(t)}finally{e.f()}}return this._originNames}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"maxItem",get:function(){var t,e={Key:x.Null,Value:0},n=m(this);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2),r=i[0],a=i[1],s=x.fromSerializedKey(r);(e.Key.isNull||a>e.Value)&&(e={Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"minItem",get:function(){var t,e={Key:x.Null,Value:0},n=m(this);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2),r=i[0],a=i[1],s=x.fromSerializedKey(r);(e.Key.isNull||a<e.Value)&&(e={Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"inverse",get:function(){var t=new s;if(null!=this.origins){var e,n=m(this.origins);try{for(n.s();!(e=n.n()).done;){var i,r=m(e.value.items);try{for(r.s();!(i=r.n()).done;){var a=v(i.value,2),o=a[0],u=a[1],l=x.fromSerializedKey(o);this.ContainsKey(l)||t.Add(l,u)}}catch(t){r.e(t)}finally{r.f()}}}catch(t){n.e(t)}finally{n.f()}}return t}},{key:"all",get:function(){var t=new s;if(null!=this.origins){var e,n=m(this.origins);try{for(n.s();!(e=n.n()).done;){var i,r=m(e.value.items);try{for(r.s();!(i=r.n()).done;){var a=v(i.value,2),o=a[0],u=a[1],l=x.fromSerializedKey(o);t.set(l.serialized(),u)}}catch(t){r.e(t)}finally{r.f()}}}catch(t){n.e(t)}finally{n.f()}}return t}},{key:"Union",value:function(t){var e,n=new s(this),i=m(t);try{for(i.s();!(e=i.n()).done;){var r=v(e.value,2),a=r[0],o=r[1];n.set(a,o)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"Intersect",value:function(t){var e,n=new s,i=m(this);try{for(i.s();!(e=i.n()).done;){var r=v(e.value,2),a=r[0],o=r[1];t.has(a)&&n.set(a,o)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"Without",value:function(t){var e,n=new s(this),i=m(t);try{for(i.s();!(e=i.n()).done;){var r=v(e.value,1)[0];n.delete(r)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"Contains",value:function(t){var e,n=m(t);try{for(n.s();!(e=n.n()).done;){var i=v(e.value,1)[0];if(!this.has(i))return!1}}catch(t){n.e(t)}finally{n.f()}return!0}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return this.Count>0?new s(this.maxItem):new s}},{key:"MinAsList",value:function(){return this.Count>0?new s(this.minItem):new s}},{key:"ListWithSubRange",value:function(t,e){if(0==this.Count)return new s;var n=this.orderedItems,i=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof s&&t.Count>0&&(i=t.minItem.Value),Number.isInteger(e)?r=e:t instanceof s&&t.Count>0&&(r=e.maxItem.Value);var a=new s;a.SetInitialOriginNames(this.originNames);var o,u=m(n);try{for(u.s();!(o=u.n()).done;){var l=o.value;l.Value>=i&&l.Value<=r&&a.Add(l.Key,l.Value)}}catch(t){u.e(t)}finally{u.f()}return a}},{key:"Equals",value:function(t){if(t instanceof s==0)return!1;if(t.Count!=this.Count)return!1;var e,n=m(this);try{for(n.s();!(e=n.n()).done;){var i=v(e.value,1)[0];if(!t.has(i))return!1}}catch(t){n.e(t)}finally{n.f()}return!0}},{key:"orderedItems",get:function(){var t,e=new Array,n=m(this);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2),r=i[0],a=i[1],s=x.fromSerializedKey(r);e.push({Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e.sort((function(t,e){return null===t.Key.originName?O("x.Key.originName"):null===e.Key.originName?O("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0})),e}},{key:"toString",value:function(){for(var t=this.orderedItems,e=new A,n=0;n<t.length;n++){n>0&&e.Append(", ");var i=t[n].Key;if(null===i.itemName)return O("item.itemName");e.Append(i.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}}],[{key:"FromString",value:function(t,e){var n,i=null===(n=e.listDefinitions)||void 0===n?void 0:n.FindSingleItemListWithName(t);if(i)return null===i.value?O("listValue.value"):new s(i.value);throw new Error("Could not find the InkListItem from the string '"+t+"' to create an InkList because it doesn't exist in the original list definition in ink.")}}]),s}(h(Map)),I=function(t){a(i,t);var e=f(i);function i(t){var r;return n(this,i),(r=e.call(this,t)).useEndLineNumber=!1,r.message=t,r.name="StoryException",r}return r(i)}(h(Error));function F(t,e,n){if(null===t)return{result:n,exists:!1};var i=t.get(e);return void 0===i?{result:n,exists:!1}:{result:i,exists:!0}}var W,V=function(t){a(i,t);var e=f(i);function i(t){var r;return n(this,i),(r=e.call(this)).value=t,r}return r(i,[{key:"valueObject",get:function(){return this.value}},{key:"toString",value:function(){return null===this.value?O("Value.value"):this.value.toString()}}]),i}(function(t){a(i,t);var e=f(i);function i(){return n(this,i),e.apply(this,arguments)}return r(i,[{key:"Copy",value:function(){return w(i.Create(this.valueObject),P)}},{key:"BadCastException",value:function(t){return new I("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}],[{key:"Create",value:function(t,e){if(e){if(e===W.Int&&Number.isInteger(Number(t)))return new R(Number(t));if(e===W.Float&&!isNaN(t))return new j(Number(t))}return"boolean"==typeof t?new L(Boolean(t)):"string"==typeof t?new D(String(t)):Number.isInteger(Number(t))?new R(Number(t)):isNaN(t)?t instanceof S?new B(w(t,S)):t instanceof N?new G(w(t,N)):null:new j(Number(t))}}]),i}(P)),L=function(t){a(i,t);var e=f(i);function i(t){return n(this,i),e.call(this,t||!1)}return r(i,[{key:"isTruthy",get:function(){return Boolean(this.value)}},{key:"valueType",get:function(){return W.Bool}},{key:"Cast",value:function(t){if(null===this.value)return O("Value.value");if(t==this.valueType)return this;if(t==W.Int)return new R(this.value?1:0);if(t==W.Float)return new j(this.value?1:0);if(t==W.String)return new D(this.value?"true":"false");throw this.BadCastException(t)}},{key:"toString",value:function(){return this.value?"true":"false"}}]),i}(V),R=function(t){a(i,t);var e=f(i);function i(t){return n(this,i),e.call(this,t||0)}return r(i,[{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return W.Int}},{key:"Cast",value:function(t){if(null===this.value)return O("Value.value");if(t==this.valueType)return this;if(t==W.Bool)return new L(0!==this.value);if(t==W.Float)return new j(this.value);if(t==W.String)return new D(""+this.value);throw this.BadCastException(t)}}]),i}(V),j=function(t){a(i,t);var e=f(i);function i(t){return n(this,i),e.call(this,t||0)}return r(i,[{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return W.Float}},{key:"Cast",value:function(t){if(null===this.value)return O("Value.value");if(t==this.valueType)return this;if(t==W.Bool)return new L(0!==this.value);if(t==W.Int)return new R(this.value);if(t==W.String)return new D(""+this.value);throw this.BadCastException(t)}}]),i}(V),D=function(t){a(i,t);var e=f(i);function i(t){var r;return n(this,i),(r=e.call(this,t||""))._isNewline="\n"==r.value,r._isInlineWhitespace=!0,null===r.value?c(r,O("Value.value")):(r.value.length>0&&r.value.split("").every((function(t){return" "==t||"\t"==t||(r._isInlineWhitespace=!1,!1)})),r)}return r(i,[{key:"valueType",get:function(){return W.String}},{key:"isTruthy",get:function(){return null===this.value?O("Value.value"):this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}},{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==W.Int){var e=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseInt(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new R(e.result);throw this.BadCastException(t)}if(t==W.Float){var n=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseFloat(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(n.exists)return new j(n.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}]),i}(V),B=function(t){a(i,t);var e=f(i);function i(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return n(this,i),e.call(this,t)}return r(i,[{key:"valueType",get:function(){return W.DivertTarget}},{key:"targetPath",get:function(){return null===this.value?O("Value.value"):this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a divert target")}},{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}}]),i}(V),M=function(t){a(i,t);var e=f(i);function i(t){var r,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return n(this,i),(r=e.call(this,t))._contextIndex=a,r}return r(i,[{key:"contextIndex",get:function(){return this._contextIndex},set:function(t){this._contextIndex=t}},{key:"variableName",get:function(){return null===this.value?O("Value.value"):this.value},set:function(t){this.value=t}},{key:"valueType",get:function(){return W.VariablePointer}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}},{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new i(this.variableName,this.contextIndex)}}]),i}(V),G=function(t){a(i,t);var e=f(i);function i(t,r){var a;return n(this,i),a=e.call(this,null),t||r?t instanceof N?a.value=new N(t):t instanceof x&&"number"==typeof r&&(a.value=new N({Key:t,Value:r})):a.value=new N,a}return r(i,[{key:"isTruthy",get:function(){return null===this.value?O("this.value"):this.value.Count>0}},{key:"valueType",get:function(){return W.List}},{key:"Cast",value:function(t){if(null===this.value)return O("Value.value");if(t==W.Int){var e=this.value.maxItem;return e.Key.isNull?new R(0):new R(e.Value)}if(t==W.Float){var n=this.value.maxItem;return n.Key.isNull?new j(0):new j(n.Value)}if(t==W.String){var i=this.value.maxItem;return i.Key.isNull?new D(""):new D(i.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}}],[{key:"RetainListOriginsForAssignment",value:function(t,e){var n=b(t,i),r=b(e,i);return r&&null===r.value?O("newList.value"):n&&null===n.value?O("oldList.value"):void(n&&r&&0==r.value.Count&&r.value.SetInitialOriginNames(n.value.originNames))}}]),i}(V);!function(t){t[t.Bool=-1]="Bool",t[t.Int=0]="Int",t[t.Float=1]="Float",t[t.List=2]="List",t[t.String=3]="String",t[t.DivertTarget=4]="DivertTarget",t[t.VariablePointer=5]="VariablePointer"}(W||(W={}));var H=function(){function t(){n(this,t),this.obj=null,this.approximate=!1}return r(t,[{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof U?this.obj:null}},{key:"copy",value:function(){var e=new t;return e.obj=this.obj,e.approximate=this.approximate,e}}]),t}(),U=function(t){a(i,t);var e=f(i);function i(){var t;return n(this,i),(t=e.apply(this,arguments)).name=null,t._content=[],t.namedContent=new Map,t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t._pathToFirstLeafContent=null,t}return r(i,[{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t,e=new Map,n=m(this.namedContent);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2),r=i[0],a=w(i[1],P);e.set(r,a)}}catch(t){n.e(t)}finally{n.f()}var s,o=m(this.content);try{for(o.s();!(s=o.n()).done;){var u=k(s.value);null!=u&&u.hasValidName&&e.delete(u.name)}}catch(t){o.e(t)}finally{o.f()}return 0==e.size&&(e=null),e},set:function(t){var e=this.namedOnlyContent;if(null!=e){var n,i=m(e);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,1)[0];this.namedContent.delete(r)}}catch(t){i.e(t)}finally{i.f()}}if(null!=t){var a,s=m(t);try{for(s.s();!(a=s.n()).done;){var o=k(v(a.value,2)[1]);null!=o&&this.AddToNamedContentOnly(o)}}catch(t){s.e(t)}finally{s.f()}}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=i.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=i.CountFlags.Turns),this.countingAtStartOnly&&(t|=i.CountFlags.CountStartOnly),t==i.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var e=t;(e&i.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&i.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&i.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=[],e=this;e instanceof i;)e.content.length>0&&(t.push(new S.Component(0)),e=e.content[0]);return new S(t)}},{key:"AddContent",value:function(t){if(t instanceof Array){var e,n=m(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;this.AddContent(i)}}catch(t){n.e(t)}finally{n.f()}}else{var r=t;if(this._content.push(r),r.parent)throw new Error("content is already in "+r.parent);r.parent=this,this.TryAddNamedContent(r)}}},{key:"TryAddNamedContent",value:function(t){var e=k(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}},{key:"AddToNamedContentOnly",value:function(t){if(g.AssertType(t,P,"Can only add Runtime.Objects to a Runtime.Container"),w(t,P).parent=this,null===t.name)return O("namedContentObj.name");this.namedContent.set(t.name,t)}},{key:"ContentAtPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;-1==n&&(n=t.length);var r=new H;r.approximate=!1;for(var a=this,s=this,o=e;o<n;++o){var u=t.GetComponent(o);if(null==a){r.approximate=!0;break}var l=a.ContentWithPathComponent(u);if(null==l){r.approximate=!0;break}s=l,a=b(l,i)}return r.obj=s,r}},{key:"InsertContent",value:function(t,e){if(this.content.splice(e,0,t),t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){var e;(e=this.content).push.apply(e,d(t.content));var n,i=m(t.content);try{for(i.s();!(n=i.n()).done;){var r=n.value;r.parent=this,this.TryAddNamedContent(r)}}catch(t){i.e(t)}finally{i.f()}}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;if(null===t.name)return O("component.name");var e=F(this.namedContent,t.name,null);return e.exists?w(e.result,P):null}},{key:"BuildStringOfHierarchy",value:function(){var t;if(0==arguments.length)return t=new A,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];var e=arguments[1],n=arguments[2];function r(){for(var n=0;n<4*e;++n)t.Append(" ")}r(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==n&&t.Append("  <---"),t.AppendLine(),e++;for(var a=0;a<this.content.length;++a){var s=this.content[a];s instanceof i?s.BuildStringOfHierarchy(t,e,n):(r(),s instanceof D?(t.Append('"'),t.Append(s.toString().replace("\n","\\n")),t.Append('"')):t.Append(s.toString())),a!=this.content.length-1&&t.Append(","),s instanceof i||s!=n||t.Append("  <---"),t.AppendLine()}var o,u=new Map,l=m(this.namedContent);try{for(l.s();!(o=l.n()).done;){var h=v(o.value,2),c=h[0],f=h[1];this.content.indexOf(w(f,P))>=0||u.set(c,f)}}catch(t){l.e(t)}finally{l.f()}if(u.size>0){r(),t.AppendLine("-- named: --");var d,p=m(u);try{for(p.s();!(d=p.n()).done;){var y=v(d.value,2)[1];g.AssertType(y,i,"Can only print out named Containers"),y.BuildStringOfHierarchy(t,e,n),t.AppendLine()}}catch(t){p.e(t)}finally{p.f()}}e--,r(),t.Append("]")}}]),i}(P);!function(t){var e;(e=t.CountFlags||(t.CountFlags={}))[e.Visits=1]="Visits",e[e.Turns=2]="Turns",e[e.CountStartOnly=4]="CountStartOnly"}(U||(U={}));var K,z=function(t){a(i,t);var e=f(i);function i(){return n(this,i),e.apply(this,arguments)}return r(i,[{key:"toString",value:function(){return"Glue"}}]),i}(P),q=function(t){a(i,t);var e=f(i);function i(){var t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i.CommandType.NotSet;return n(this,i),(t=e.call(this))._commandType=r,t}return r(i,[{key:"commandType",get:function(){return this._commandType}},{key:"Copy",value:function(){return new i(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}}],[{key:"EvalStart",value:function(){return new i(i.CommandType.EvalStart)}},{key:"EvalOutput",value:function(){return new i(i.CommandType.EvalOutput)}},{key:"EvalEnd",value:function(){return new i(i.CommandType.EvalEnd)}},{key:"Duplicate",value:function(){return new i(i.CommandType.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new i(i.CommandType.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new i(i.CommandType.PopFunction)}},{key:"PopTunnel",value:function(){return new i(i.CommandType.PopTunnel)}},{key:"BeginString",value:function(){return new i(i.CommandType.BeginString)}},{key:"EndString",value:function(){return new i(i.CommandType.EndString)}},{key:"NoOp",value:function(){return new i(i.CommandType.NoOp)}},{key:"ChoiceCount",value:function(){return new i(i.CommandType.ChoiceCount)}},{key:"Turns",value:function(){return new i(i.CommandType.Turns)}},{key:"TurnsSince",value:function(){return new i(i.CommandType.TurnsSince)}},{key:"ReadCount",value:function(){return new i(i.CommandType.ReadCount)}},{key:"Random",value:function(){return new i(i.CommandType.Random)}},{key:"SeedRandom",value:function(){return new i(i.CommandType.SeedRandom)}},{key:"VisitIndex",value:function(){return new i(i.CommandType.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new i(i.CommandType.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new i(i.CommandType.StartThread)}},{key:"Done",value:function(){return new i(i.CommandType.Done)}},{key:"End",value:function(){return new i(i.CommandType.End)}},{key:"ListFromInt",value:function(){return new i(i.CommandType.ListFromInt)}},{key:"ListRange",value:function(){return new i(i.CommandType.ListRange)}},{key:"ListRandom",value:function(){return new i(i.CommandType.ListRandom)}}]),i}(P);!function(t){var e;(e=t.CommandType||(t.CommandType={}))[e.NotSet=-1]="NotSet",e[e.EvalStart=0]="EvalStart",e[e.EvalOutput=1]="EvalOutput",e[e.EvalEnd=2]="EvalEnd",e[e.Duplicate=3]="Duplicate",e[e.PopEvaluatedValue=4]="PopEvaluatedValue",e[e.PopFunction=5]="PopFunction",e[e.PopTunnel=6]="PopTunnel",e[e.BeginString=7]="BeginString",e[e.EndString=8]="EndString",e[e.NoOp=9]="NoOp",e[e.ChoiceCount=10]="ChoiceCount",e[e.Turns=11]="Turns",e[e.TurnsSince=12]="TurnsSince",e[e.Random=13]="Random",e[e.SeedRandom=14]="SeedRandom",e[e.VisitIndex=15]="VisitIndex",e[e.SequenceShuffleIndex=16]="SequenceShuffleIndex",e[e.StartThread=17]="StartThread",e[e.Done=18]="Done",e[e.End=19]="End",e[e.ListFromInt=20]="ListFromInt",e[e.ListRange=21]="ListRange",e[e.ListRandom=22]="ListRandom",e[e.ReadCount=23]="ReadCount",e[e.TOTAL_VALUES=24]="TOTAL_VALUES"}(q||(q={})),function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(K||(K={}));var J=function(){function t(){n(this,t),this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}return r(t,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new S.Component(this.index)):this.container.path}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new t(this.container,this.index)}}],[{key:"StartOf",value:function(e){return new t(e,0)}},{key:"Null",get:function(){return new t(null,-1)}}]),t}(),Z=function(t){a(i,t);var e=f(i);function i(t){var r;return n(this,i),(r=e.call(this))._targetPath=null,r._targetPointer=J.Null,r.variableDivertName=null,r.pushesToStack=!1,r.stackPushType=0,r.isExternal=!1,r.externalArgs=0,r.isConditional=!1,r.pushesToStack=!1,void 0!==t&&(r.pushesToStack=!0,r.stackPushType=t),r}return r(i,[{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetPointer=J.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return O("this._targetPath");if(null===this._targetPath.lastComponent)return O("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return O("targetObj");this._targetPointer.container=t.parent instanceof U?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=J.StartOf(t instanceof U?t:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new S(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}},{key:"Equals",value:function(t){var e=t;return e instanceof i&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:null===this.targetPath?O("this.targetPath"):this.targetPath.Equals(e.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new A,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==K.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}]),i}(P),X=function(t){a(i,t);var e=f(i);function i(){var t,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return n(this,i),(t=e.call(this))._pathOnChoice=null,t.hasCondition=!1,t.hasStartContent=!1,t.hasChoiceOnlyContent=!1,t.isInvisibleDefault=!1,t.onceOnly=!0,t.onceOnly=r,t}return r(i,[{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return null===this._pathOnChoice?O("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return null===this.pathOnChoice?O("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new S(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}},{key:"toString",value:function(){return null===this.pathOnChoice?O("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}]),i}(P),Q=function(t){a(i,t);var e=f(i);function i(){var t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return n(this,i),(t=e.call(this)).pathForCount=null,t.name=r,t}return r(i,[{key:"containerForCount",get:function(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null===t?null:new S(t)}},{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}]),i}(P),$=function(t){a(i,t);var e=f(i);function i(t,r){var a;return n(this,i),(a=e.call(this)).variableName=t||null,a.isNewDeclaration=!!r,a.isGlobal=!1,a}return r(i,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}}]),i}(P),Y=function(t){a(i,t);var e=f(i);function i(){return n(this,i),e.apply(this,arguments)}return r(i)}(P),tt=function(t){a(i,t);var e=f(i);function i(){var t;if(n(this,i),(t=e.call(this))._name=null,t._numberOfParameters=0,t._prototype=null,t._isPrototype=!1,t._operationFuncs=null,0===arguments.length)i.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){var r=arguments[0];i.GenerateNativeFunctionsIfNecessary(),t.name=r}else if(2===arguments.length){var a=arguments[0],s=arguments[1];t._isPrototype=!0,t.name=a,t.numberOfParameters=s}return t}return r(i,[{key:"name",get:function(){return null===this._name?O("NativeFunctionCall._name"):this._name},set:function(t){this._name=t,this._isPrototype||(null===i._nativeFunctions?O("NativeFunctionCall._nativeFunctions"):this._prototype=i._nativeFunctions.get(this._name)||null)}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}},{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");var e,n=!1,i=m(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;if(r instanceof Y)throw new I('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');r instanceof G&&(n=!0)}}catch(t){i.e(t)}finally{i.f()}if(2==t.length&&n)return this.CallBinaryListOperation(t);var a=this.CoerceValuesToSingleType(t),s=a[0].valueType;return s==W.Int||s==W.Float||s==W.String||s==W.DivertTarget||s==W.List?this.CallType(a):null}},{key:"CallType",value:function(t){var e=w(t[0],V),n=e.valueType,r=e,a=t.length;if(2==a||1==a){if(null===this._operationFuncs)return O("NativeFunctionCall._operationFuncs");var s=this._operationFuncs.get(n);if(!s){var o=W[n];throw new I("Cannot perform operation "+this.name+" on "+o)}if(2==a){var u=w(t[1],V),l=s;if(null===r.value||null===u.value)return O("NativeFunctionCall.Call BinaryOp values");var h=l(r.value,u.value);return V.Create(h)}var c=s;if(null===r.value)return O("NativeFunctionCall.Call UnaryOp value");var f=c(r.value);return this.name===i.Int?V.Create(f,W.Int):this.name===i.Float?V.Create(f,W.Float):V.Create(f,e.valueType)}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof G&&t[1]instanceof R)return this.CallListIncrementOperation(t);var e=w(t[0],V),n=w(t[1],V);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==W.List&&n.valueType==W.List)){if(null===this._operationFuncs)return O("NativeFunctionCall._operationFuncs");var i=this._operationFuncs.get(W.Int);if(null===i)return O("NativeFunctionCall.CallBinaryListOperation op");var r=function(t){if("boolean"==typeof t)return t;throw new Error("".concat(t," is not a boolean"))}(i(e.isTruthy?1:0,n.isTruthy?1:0));return new L(r)}if(e.valueType==W.List&&n.valueType==W.List)return this.CallType([e,n]);throw new I("Can not call use "+this.name+" operation on "+W[e.valueType]+" and "+W[n.valueType])}},{key:"CallListIncrementOperation",value:function(t){var e=w(t[0],G),n=w(t[1],R),i=new N;if(null===e.value)return O("NativeFunctionCall.CallListIncrementOperation listVal.value");var r,a=m(e.value);try{for(a.s();!(r=a.n()).done;){var s=v(r.value,2),o=s[0],u=s[1],l=x.fromSerializedKey(o);if(null===this._operationFuncs)return O("NativeFunctionCall._operationFuncs");var h=this._operationFuncs.get(W.Int);if(null===n.value)return O("NativeFunctionCall.CallListIncrementOperation intVal.value");var c=h(u,n.value),f=null;if(null===e.value.origins)return O("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");var d,p=m(e.value.origins);try{for(p.s();!(d=p.n()).done;){var y=d.value;if(y.name==l.originName){f=y;break}}}catch(t){p.e(t)}finally{p.f()}if(null!=f){var g=f.TryGetItemWithValue(c,x.Null);g.exists&&i.Add(g.result,c)}}}catch(t){a.e(t)}finally{a.f()}return new G(i)}},{key:"CoerceValuesToSingleType",value:function(t){var e,n=W.Int,i=null,r=m(t);try{for(r.s();!(e=r.n()).done;){var a=w(e.value,V);a.valueType>n&&(n=a.valueType),a.valueType==W.List&&(i=b(a,G))}}catch(t){r.e(t)}finally{r.f()}var s=[];if(W[n]==W[W.List]){var o,u=m(t);try{for(u.s();!(o=u.n()).done;){var l=w(o.value,V);if(l.valueType==W.List)s.push(l);else{if(l.valueType!=W.Int){var h=W[l.valueType];throw new I("Cannot mix Lists and "+h+" values in this operation")}var c=parseInt(l.valueObject);if(null===(i=w(i,G)).value)return O("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");var f=i.value.originOfMaxItem;if(null===f)return O("NativeFunctionCall.CoerceValuesToSingleType list");var v=f.TryGetItemWithValue(c,x.Null);if(!v.exists)throw new I("Could not find List item with the value "+c+" in "+f.name);var d=new G(v.result,c);s.push(d)}}}catch(t){u.e(t)}finally{u.f()}}else{var p,y=m(t);try{for(y.s();!(p=y.n()).done;){var g=w(p.value,V).Cast(n);s.push(g)}}catch(t){y.e(t)}finally{y.f()}}return s}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}},{key:"toString",value:function(){return'Native "'+this.name+'"'}}],[{key:"CallWithName",value:function(t){return new i(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}},{key:"Identity",value:function(t){return t}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){null==this._nativeFunctions&&(this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(function(t,e){return t+e})),this.AddIntBinaryOp(this.Subtract,(function(t,e){return t-e})),this.AddIntBinaryOp(this.Multiply,(function(t,e){return t*e})),this.AddIntBinaryOp(this.Divide,(function(t,e){return Math.floor(t/e)})),this.AddIntBinaryOp(this.Mod,(function(t,e){return t%e})),this.AddIntUnaryOp(this.Negate,(function(t){return-t})),this.AddIntBinaryOp(this.Equal,(function(t,e){return t==e})),this.AddIntBinaryOp(this.Greater,(function(t,e){return t>e})),this.AddIntBinaryOp(this.Less,(function(t,e){return t<e})),this.AddIntBinaryOp(this.GreaterThanOrEquals,(function(t,e){return t>=e})),this.AddIntBinaryOp(this.LessThanOrEquals,(function(t,e){return t<=e})),this.AddIntBinaryOp(this.NotEquals,(function(t,e){return t!=e})),this.AddIntUnaryOp(this.Not,(function(t){return 0==t})),this.AddIntBinaryOp(this.And,(function(t,e){return 0!=t&&0!=e})),this.AddIntBinaryOp(this.Or,(function(t,e){return 0!=t||0!=e})),this.AddIntBinaryOp(this.Max,(function(t,e){return Math.max(t,e)})),this.AddIntBinaryOp(this.Min,(function(t,e){return Math.min(t,e)})),this.AddIntBinaryOp(this.Pow,(function(t,e){return Math.pow(t,e)})),this.AddIntUnaryOp(this.Floor,i.Identity),this.AddIntUnaryOp(this.Ceiling,i.Identity),this.AddIntUnaryOp(this.Int,i.Identity),this.AddIntUnaryOp(this.Float,(function(t){return t})),this.AddFloatBinaryOp(this.Add,(function(t,e){return t+e})),this.AddFloatBinaryOp(this.Subtract,(function(t,e){return t-e})),this.AddFloatBinaryOp(this.Multiply,(function(t,e){return t*e})),this.AddFloatBinaryOp(this.Divide,(function(t,e){return t/e})),this.AddFloatBinaryOp(this.Mod,(function(t,e){return t%e})),this.AddFloatUnaryOp(this.Negate,(function(t){return-t})),this.AddFloatBinaryOp(this.Equal,(function(t,e){return t==e})),this.AddFloatBinaryOp(this.Greater,(function(t,e){return t>e})),this.AddFloatBinaryOp(this.Less,(function(t,e){return t<e})),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(function(t,e){return t>=e})),this.AddFloatBinaryOp(this.LessThanOrEquals,(function(t,e){return t<=e})),this.AddFloatBinaryOp(this.NotEquals,(function(t,e){return t!=e})),this.AddFloatUnaryOp(this.Not,(function(t){return 0==t})),this.AddFloatBinaryOp(this.And,(function(t,e){return 0!=t&&0!=e})),this.AddFloatBinaryOp(this.Or,(function(t,e){return 0!=t||0!=e})),this.AddFloatBinaryOp(this.Max,(function(t,e){return Math.max(t,e)})),this.AddFloatBinaryOp(this.Min,(function(t,e){return Math.min(t,e)})),this.AddFloatBinaryOp(this.Pow,(function(t,e){return Math.pow(t,e)})),this.AddFloatUnaryOp(this.Floor,(function(t){return Math.floor(t)})),this.AddFloatUnaryOp(this.Ceiling,(function(t){return Math.ceil(t)})),this.AddFloatUnaryOp(this.Int,(function(t){return Math.floor(t)})),this.AddFloatUnaryOp(this.Float,i.Identity),this.AddStringBinaryOp(this.Add,(function(t,e){return t+e})),this.AddStringBinaryOp(this.Equal,(function(t,e){return t===e})),this.AddStringBinaryOp(this.NotEquals,(function(t,e){return!(t===e)})),this.AddStringBinaryOp(this.Has,(function(t,e){return t.includes(e)})),this.AddStringBinaryOp(this.Hasnt,(function(t,e){return!t.includes(e)})),this.AddListBinaryOp(this.Add,(function(t,e){return t.Union(e)})),this.AddListBinaryOp(this.Subtract,(function(t,e){return t.Without(e)})),this.AddListBinaryOp(this.Has,(function(t,e){return t.Contains(e)})),this.AddListBinaryOp(this.Hasnt,(function(t,e){return!t.Contains(e)})),this.AddListBinaryOp(this.Intersect,(function(t,e){return t.Intersect(e)})),this.AddListBinaryOp(this.Equal,(function(t,e){return t.Equals(e)})),this.AddListBinaryOp(this.Greater,(function(t,e){return t.GreaterThan(e)})),this.AddListBinaryOp(this.Less,(function(t,e){return t.LessThan(e)})),this.AddListBinaryOp(this.GreaterThanOrEquals,(function(t,e){return t.GreaterThanOrEquals(e)})),this.AddListBinaryOp(this.LessThanOrEquals,(function(t,e){return t.LessThanOrEquals(e)})),this.AddListBinaryOp(this.NotEquals,(function(t,e){return!t.Equals(e)})),this.AddListBinaryOp(this.And,(function(t,e){return t.Count>0&&e.Count>0})),this.AddListBinaryOp(this.Or,(function(t,e){return t.Count>0||e.Count>0})),this.AddListUnaryOp(this.Not,(function(t){return 0==t.Count?1:0})),this.AddListUnaryOp(this.Invert,(function(t){return t.inverse})),this.AddListUnaryOp(this.All,(function(t){return t.all})),this.AddListUnaryOp(this.ListMin,(function(t){return t.MinAsList()})),this.AddListUnaryOp(this.ListMax,(function(t){return t.MaxAsList()})),this.AddListUnaryOp(this.Count,(function(t){return t.Count})),this.AddListUnaryOp(this.ValueOfList,(function(t){return t.maxItem.Value})),this.AddOpToNativeFunc(this.Equal,2,W.DivertTarget,(function(t,e){return t.Equals(e)})),this.AddOpToNativeFunc(this.NotEquals,2,W.DivertTarget,(function(t,e){return!t.Equals(e)})))}},{key:"AddOpToNativeFunc",value:function(t,e,n,r){if(null===this._nativeFunctions)return O("NativeFunctionCall._nativeFunctions");var a=this._nativeFunctions.get(t);a||(a=new i(t,e),this._nativeFunctions.set(t,a)),a.AddOpFuncForType(n,r)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,W.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,W.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,W.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,W.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,W.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,W.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,W.List,e)}}]),i}(P);tt.Add="+",tt.Subtract="-",tt.Divide="/",tt.Multiply="*",tt.Mod="%",tt.Negate="_",tt.Equal="==",tt.Greater=">",tt.Less="<",tt.GreaterThanOrEquals=">=",tt.LessThanOrEquals="<=",tt.NotEquals="!=",tt.Not="!",tt.And="&&",tt.Or="||",tt.Min="MIN",tt.Max="MAX",tt.Pow="POW",tt.Floor="FLOOR",tt.Ceiling="CEILING",tt.Int="INT",tt.Float="FLOAT",tt.Has="?",tt.Hasnt="!?",tt.Intersect="^",tt.ListMin="LIST_MIN",tt.ListMax="LIST_MAX",tt.All="LIST_ALL",tt.Count="LIST_COUNT",tt.ValueOfList="LIST_VALUE",tt.Invert="LIST_INVERT",tt._nativeFunctions=null;var et=function(t){a(i,t);var e=f(i);function i(t){var r;return n(this,i),(r=e.call(this)).text=t.toString()||"",r}return r(i,[{key:"toString",value:function(){return"# "+this.text}}]),i}(P),nt=function(t){a(i,t);var e=f(i);function i(){var t;return n(this,i),(t=e.apply(this,arguments)).text="",t.index=0,t.threadAtGeneration=null,t.sourcePath="",t.targetPath=null,t.isInvisibleDefault=!1,t.originalThreadIndex=0,t}return r(i,[{key:"pathStringOnChoice",get:function(){return null===this.targetPath?O("Choice.targetPath"):this.targetPath.toString()},set:function(t){this.targetPath=new S(t)}}]),i}(P),it=function(){function t(e,i){n(this,t),this._name=e||"",this._items=null,this._itemNameToValues=i||new Map}return r(t,[{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items){this._items=new Map;var t,e=m(this._itemNameToValues);try{for(e.s();!(t=e.n()).done;){var n=v(t.value,2),i=n[0],r=n[1],a=new x(this.name,i);this._items.set(a.serialized(),r)}}catch(t){e.e(t)}finally{e.f()}}return this._items}},{key:"ValueForItem",value:function(t){if(!t.itemName)return 0;var e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}},{key:"ContainsItemWithName",value:function(t){return this._itemNameToValues.has(t)}},{key:"TryGetItemWithValue",value:function(t,e){var n,i=m(this._itemNameToValues);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,2),a=r[0];if(r[1]==t)return{result:new x(this.name,a),exists:!0}}}catch(t){i.e(t)}finally{i.f()}return{result:x.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t,e){if(!t.itemName)return{result:0,exists:!1};var n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}}]),t}(),rt=function(){function t(e){n(this,t),this._lists=new Map,this._allUnambiguousListValueCache=new Map;var i,r=m(e);try{for(r.s();!(i=r.n()).done;){var a=i.value;this._lists.set(a.name,a);var s,o=m(a.items);try{for(o.s();!(s=o.n()).done;){var u=v(s.value,2),l=u[0],h=u[1],c=x.fromSerializedKey(l),f=new G(c,h);if(!c.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(c.itemName,f),this._allUnambiguousListValueCache.set(c.fullName,f)}}catch(t){o.e(t)}finally{o.f()}}}catch(t){r.e(t)}finally{r.f()}}return r(t,[{key:"lists",get:function(){var t,e=[],n=m(this._lists);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2)[1];e.push(i)}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"TryListGetDefinition",value:function(t,e){if(null===t)return{result:e,exists:!1};var n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}},{key:"FindSingleItemListWithName",value:function(t){if(null===t)return O("name");var e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}}]),t}(),at=function(){function t(){n(this,t)}return r(t,null,[{key:"JArrayToRuntimeObjList",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=t.length;e&&n--;for(var i=[],r=0;r<n;r++){var a=t[r],s=this.JTokenToRuntimeObject(a);if(null===s)return O("runtimeObj");i.push(s)}return i}},{key:"WriteDictionaryRuntimeObjs",value:function(t,e){t.WriteObjectStart();var n,i=m(e);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,2),a=r[0],s=r[1];t.WritePropertyStart(a),this.WriteRuntimeObject(t,s),t.WritePropertyEnd()}}catch(t){i.e(t)}finally{i.f()}t.WriteObjectEnd()}},{key:"WriteListRuntimeObjs",value:function(t,e){t.WriteArrayStart();var n,i=m(e);try{for(i.s();!(n=i.n()).done;){var r=n.value;this.WriteRuntimeObject(t,r)}}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd()}},{key:"WriteIntDictionary",value:function(t,e){t.WriteObjectStart();var n,i=m(e);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,2),a=r[0],s=r[1];t.WriteIntProperty(a,s)}}catch(t){i.e(t)}finally{i.f()}t.WriteObjectEnd()}},{key:"WriteRuntimeObject",value:function(e,n){var i=b(n,U);if(i)this.WriteRuntimeContainer(e,i);else{var r=b(n,Z);if(r){var a,s="->";return r.isExternal?s="x()":r.pushesToStack&&(r.stackPushType==K.Function?s="f()":r.stackPushType==K.Tunnel&&(s="->t->")),a=r.hasVariableTarget?r.variableDivertName:r.targetPathString,e.WriteObjectStart(),e.WriteProperty(s,a),r.hasVariableTarget&&e.WriteProperty("var",!0),r.isConditional&&e.WriteProperty("c",!0),r.externalArgs>0&&e.WriteIntProperty("exArgs",r.externalArgs),void e.WriteObjectEnd()}var o=b(n,X);if(o)return e.WriteObjectStart(),e.WriteProperty("*",o.pathStringOnChoice),e.WriteIntProperty("flg",o.flags),void e.WriteObjectEnd();var u=b(n,L);if(u)e.WriteBool(u.value);else{var l=b(n,R);if(l)e.WriteInt(l.value);else{var h=b(n,j);if(h)e.WriteFloat(h.value);else{var c=b(n,D);if(c)c.isNewline?e.Write("\n",!1):(e.WriteStringStart(),e.WriteStringInner("^"),e.WriteStringInner(c.value),e.WriteStringEnd());else{var f=b(n,G);if(f)this.WriteInkList(e,f);else{var v=b(n,B);if(v)return e.WriteObjectStart(),null===v.value?O("divTargetVal.value"):(e.WriteProperty("^->",v.value.componentsString),void e.WriteObjectEnd());var d=b(n,M);if(d)return e.WriteObjectStart(),e.WriteProperty("^var",d.value),e.WriteIntProperty("ci",d.contextIndex),void e.WriteObjectEnd();if(b(n,z))e.Write("<>");else{var p=b(n,q);if(p)e.Write(t._controlCommandNames[p.commandType]);else{var y=b(n,tt);if(y){var m=y.name;return"^"==m&&(m="L^"),void e.Write(m)}var g=b(n,Q);if(g){e.WriteObjectStart();var S=g.pathStringForCount;return null!=S?e.WriteProperty("CNT?",S):e.WriteProperty("VAR?",g.name),void e.WriteObjectEnd()}var w=b(n,$);if(w){e.WriteObjectStart();var k=w.isGlobal?"VAR=":"temp=";return e.WriteProperty(k,w.variableName),w.isNewDeclaration||e.WriteProperty("re",!0),void e.WriteObjectEnd()}if(b(n,Y))e.Write("void");else{var C=b(n,et);if(C)return e.WriteObjectStart(),e.WriteProperty("#",C.text),void e.WriteObjectEnd();var _=b(n,nt);if(!_)throw new Error("Failed to convert runtime object to Json token: "+n);this.WriteChoice(e,_)}}}}}}}}}}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e=new Map;for(var n in t)if(t.hasOwnProperty(n)){var i=this.JTokenToRuntimeObject(t[n]);if(null===i)return O("inkObject");e.set(n,i)}return e}},{key:"JObjectToIntDictionary",value:function(t){var e=new Map;for(var n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}},{key:"JTokenToRuntimeObject",value:function(n){if("number"==typeof n&&!isNaN(n)||"boolean"==typeof n)return V.Create(n);if("string"==typeof n){var i=n.toString(),r=i[0];if("^"==r)return new D(i.substring(1));if("\n"==r&&1==i.length)return new D("\n");if("<>"==i)return new z;for(var a=0;a<t._controlCommandNames.length;++a)if(i==t._controlCommandNames[a])return new q(a);if("L^"==i&&(i="^"),tt.CallExistsWithName(i))return tt.CallWithName(i);if("->->"==i)return q.PopTunnel();if("~ret"==i)return q.PopFunction();if("void"==i)return new Y}if("object"===e(n)&&!Array.isArray(n)){var s,o=n;if(o["^->"])return s=o["^->"],new B(new S(s.toString()));if(o["^var"]){s=o["^var"];var u=new M(s.toString());return"ci"in o&&(s=o.ci,u.contextIndex=parseInt(s)),u}var l=!1,h=!1,c=K.Function,f=!1;if((s=o["->"])?l=!0:(s=o["f()"])?(l=!0,h=!0,c=K.Function):(s=o["->t->"])?(l=!0,h=!0,c=K.Tunnel):(s=o["x()"])&&(l=!0,f=!0,h=!1,c=K.Function),l){var v=new Z;v.pushesToStack=h,v.stackPushType=c,v.isExternal=f;var d=s.toString();return(s=o.var)?v.variableDivertName=d:v.targetPathString=d,v.isConditional=!!o.c,f&&(s=o.exArgs)&&(v.externalArgs=parseInt(s)),v}if(s=o["*"]){var p=new X;return p.pathStringOnChoice=s.toString(),(s=o.flg)&&(p.flags=parseInt(s)),p}if(s=o["VAR?"])return new Q(s.toString());if(s=o["CNT?"]){var y=new Q;return y.pathStringForCount=s.toString(),y}var m=!1,g=!1;if((s=o["VAR="])?(m=!0,g=!0):(s=o["temp="])&&(m=!0,g=!1),m){var b=s.toString(),w=!o.re,k=new $(b,w);return k.isGlobal=g,k}if(void 0!==o["#"])return s=o["#"],new et(s.toString());if(s=o.list){var C=s,_=new N;if(s=o.origins){var E=s;_.SetInitialOriginNames(E)}for(var T in C)if(C.hasOwnProperty(T)){var O=C[T],P=new x(T),A=parseInt(O);_.Add(P,A)}return new G(_)}if(null!=o.originalChoicePath)return this.JObjectToChoice(o)}if(Array.isArray(n))return this.JArrayToContainer(n);if(null==n)return null;throw new Error("Failed to convert token to runtime object: "+this.toJson(n,["parent"]))}},{key:"toJson",value:function(t,e,n){return JSON.stringify(t,(function(t,n){return(null==e?void 0:e.some((function(e){return e===t})))?void 0:n}),n)}},{key:"WriteRuntimeContainer",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.WriteArrayStart(),null===e)return O("container");var i,r=m(e.content);try{for(r.s();!(i=r.n()).done;){var a=i.value;this.WriteRuntimeObject(t,a)}}catch(t){r.e(t)}finally{r.f()}var s=e.namedOnlyContent,o=e.countFlags,u=null!=e.name&&!n,l=null!=s||o>0||u;if(l&&t.WriteObjectStart(),null!=s){var h,c=m(s);try{for(c.s();!(h=c.n()).done;){var f=v(h.value,2),d=f[0],p=f[1],y=d,g=b(p,U);t.WritePropertyStart(y),this.WriteRuntimeContainer(t,g,!0),t.WritePropertyEnd()}}catch(t){c.e(t)}finally{c.f()}}o>0&&t.WriteIntProperty("#f",o),u&&t.WriteProperty("#n",e.name),l?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}},{key:"JArrayToContainer",value:function(t){var e=new U;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i=new Map;for(var r in n)if("#f"==r)e.countFlags=parseInt(n[r]);else if("#n"==r)e.name=n[r].toString();else{var a=this.JTokenToRuntimeObject(n[r]),s=b(a,U);s&&(s.name=r),i.set(r,a)}e.namedOnlyContent=i}return e}},{key:"JObjectToChoice",value:function(t){var e=new nt;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}},{key:"WriteChoice",value:function(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),t.WriteObjectEnd()}},{key:"WriteInkList",value:function(t,e){var n=e.value;if(null===n)return O("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();var i,r=m(n);try{for(r.s();!(i=r.n()).done;){var a=v(i.value,2),s=a[0],o=a[1],u=x.fromSerializedKey(s),l=o;if(null===u.itemName)return O("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(u.originName?u.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(u.itemName),t.WritePropertyNameEnd(),t.Write(l),t.WritePropertyEnd()}}catch(t){r.e(t)}finally{r.f()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==n.Count&&null!=n.originNames&&n.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();var h,c=m(n.originNames);try{for(c.s();!(h=c.n()).done;){var f=h.value;t.Write(f)}}catch(t){c.e(t)}finally{c.f()}t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}},{key:"ListDefinitionsToJToken",value:function(t){var e,n={},i=m(t.lists);try{for(i.s();!(e=i.n()).done;){var r,a=e.value,s={},o=m(a.items);try{for(o.s();!(r=o.n()).done;){var u=v(r.value,2),l=u[0],h=u[1],c=x.fromSerializedKey(l);if(null===c.itemName)return O("item.itemName");s[c.itemName]=h}}catch(t){o.e(t)}finally{o.f()}n[a.name]=s}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e)if(e.hasOwnProperty(i)){var r=i.toString(),a=e[i],s=new Map;for(var o in a)if(e.hasOwnProperty(i)){var u=a[o];s.set(o,parseInt(u))}var l=new it(r,s);n.push(l)}return new rt(n)}}]),t}();at._controlCommandNames=function(){var t=[];t[q.CommandType.EvalStart]="ev",t[q.CommandType.EvalOutput]="out",t[q.CommandType.EvalEnd]="/ev",t[q.CommandType.Duplicate]="du",t[q.CommandType.PopEvaluatedValue]="pop",t[q.CommandType.PopFunction]="~ret",t[q.CommandType.PopTunnel]="->->",t[q.CommandType.BeginString]="str",t[q.CommandType.EndString]="/str",t[q.CommandType.NoOp]="nop",t[q.CommandType.ChoiceCount]="choiceCnt",t[q.CommandType.Turns]="turn",t[q.CommandType.TurnsSince]="turns",t[q.CommandType.ReadCount]="readc",t[q.CommandType.Random]="rnd",t[q.CommandType.SeedRandom]="srnd",t[q.CommandType.VisitIndex]="visit",t[q.CommandType.SequenceShuffleIndex]="seq",t[q.CommandType.StartThread]="thread",t[q.CommandType.Done]="done",t[q.CommandType.End]="end",t[q.CommandType.ListFromInt]="listInt",t[q.CommandType.ListRange]="range",t[q.CommandType.ListRandom]="lrnd";for(var e=0;e<q.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t}();var st=function(){function e(){if(n(this,e),this._threadCounter=0,this._startOfRoot=J.Null,arguments[0]instanceof t.Story){var i=arguments[0];this._startOfRoot=J.StartOf(i.rootContentContainer),this.Reset()}else{var r=arguments[0];this._threads=[];var a,s=m(r._threads);try{for(s.s();!(a=s.n()).done;){var o=a.value;this._threads.push(o.Copy())}}catch(t){s.e(t)}finally{s.f()}this._threadCounter=r._threadCounter,this._startOfRoot=r._startOfRoot.copy()}}return r(e,[{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){g.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"Reset",value:function(){this._threads=[],this._threads.push(new e.Thread),this._threads[0].callstack.push(new e.Element(K.Tunnel,this._startOfRoot))}},{key:"SetJsonToken",value:function(t,n){this._threads.length=0;var i,r=m(t.threads);try{for(r.s();!(i=r.n()).done;){var a=i.value,s=new e.Thread(a,n);this._threads.push(s)}}catch(t){r.e(t)}finally{r.f()}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=J.StartOf(n.rootContentContainer)}},{key:"WriteJson",value:function(t){var e=this;t.WriteObject((function(t){t.WritePropertyStart("threads"),t.WriteArrayStart();var n,i=m(e._threads);try{for(i.s();!(n=i.n()).done;)n.value.WriteJson(t)}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(e._threadCounter),t.WritePropertyEnd()}))}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"ForkThread",value:function(){var t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}},{key:"PopThread",value:function(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"canPopThread",get:function(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==K.FunctionEvaluationFromGame}},{key:"Push",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=new e.Element(t,this.currentElement.currentPointer,!1);r.evaluationStackHeightWhenPushed=n,r.functionStartInOutputStream=i,this.callStack.push(r)}},{key:"CanPop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return!!this.canPop&&(null==t||this.currentElement.type==t)}},{key:"Pop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}},{key:"GetTemporaryVariableWithName",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;-1==e&&(e=this.currentElementIndex+1);var n=F(this.callStack[e-1].temporaryVariables,t,null);return n.exists?n.result:null}},{key:"SetTemporaryVariable",value:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;-1==i&&(i=this.currentElementIndex+1);var r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw new Error("Could not find temporary variable to set: "+t);var a=F(r.temporaryVariables,t,null);a.exists&&G.RetainListOriginsForAssignment(a.result,e),r.temporaryVariables.set(t,e)}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){var e=this._threads.filter((function(e){if(e.threadIndex==t)return e}));return e.length>0?e[0]:null}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var t=new A,e=0;e<this._threads.length;e++){var n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,i?"(current) ":"");for(var r=0;r<n.callstack.length;r++){n.callstack[r].type==K.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");var a=n.callstack[r].currentPointer;if(!a.isNull){if(t.Append("<SOMEWHERE IN "),null===a.container)return O("pointer.container");t.Append(a.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}]),e}();!function(t){var e=function(){function t(e,i){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];n(this,t),this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=i.copy(),this.inExpressionEvaluation=r,this.temporaryVariables=new Map,this.type=e}return r(t,[{key:"Copy",value:function(){var e=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return e.temporaryVariables=new Map(this.temporaryVariables),e.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,e.functionStartInOutputStream=this.functionStartInOutputStream,e}}]),t}();t.Element=e;var i=function(){function t(){if(n(this,t),this.threadIndex=0,this.previousPointer=J.Null,this.callstack=[],arguments[0]&&arguments[1]){var i=arguments[0],r=arguments[1];this.threadIndex=parseInt(i.threadIndex);var a,s=m(i.callstack);try{for(s.s();!(a=s.n()).done;){var o=a.value,u=parseInt(o.type),l=J.Null,h=void 0,c=o.cPath;if(void 0!==c){h=c.toString();var f=r.ContentAtPath(new S(h));if(l.container=f.container,l.index=parseInt(o.idx),null==f.obj)throw new Error("When loading state, internal story location couldn't be found: "+h+". Has the story changed since this save data was created?");if(f.approximate){if(null===l.container)return O("pointer.container");r.Warning("When loading state, exact internal story location couldn't be found: '"+h+"', so it was approximated to '"+l.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}var v=!!o.exp,d=new e(u,l,v),p=o.temp;void 0!==p?d.temporaryVariables=at.JObjectToDictionaryRuntimeObjs(p):d.temporaryVariables.clear(),this.callstack.push(d)}}catch(t){s.e(t)}finally{s.f()}var y=i.previousContentObject;if(void 0!==y){var g=new S(y.toString());this.previousPointer=r.PointerAtPath(g)}}}return r(t,[{key:"Copy",value:function(){var e=new t;e.threadIndex=this.threadIndex;var n,i=m(this.callstack);try{for(i.s();!(n=i.n()).done;){var r=n.value;e.callstack.push(r.Copy())}}catch(t){i.e(t)}finally{i.f()}return e.previousPointer=this.previousPointer.copy(),e}},{key:"WriteJson",value:function(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();var e,n=m(this.callstack);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(t.WriteObjectStart(),!i.currentPointer.isNull){if(null===i.currentPointer.container)return O("el.currentPointer.container");t.WriteProperty("cPath",i.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",i.currentPointer.index)}t.WriteProperty("exp",i.inExpressionEvaluation),t.WriteIntProperty("type",i.type),i.temporaryVariables.size>0&&(t.WritePropertyStart("temp"),at.WriteDictionaryRuntimeObjs(t,i.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}}catch(t){n.e(t)}finally{n.f()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){var r=this.previousPointer.Resolve();if(null===r)return O("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",r.path.toString())}t.WriteObjectEnd()}}]),t}();t.Thread=i}(st||(st={}));var ot=function(){function t(e,i){n(this,t),this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=e,this._listDefsOrigin=i;try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(t){}}return r(t,[{key:"variableChangedEvent",value:function(t,e){var n,i=m(this.variableChangedEventCallbacks);try{for(i.s();!(n=i.n()).done;)(0,n.value)(t,e)}catch(t){i.e(t)}finally{i.f()}}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){if(this._batchObservingVariableChanges=t,t)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){var e,n=m(this._changedVariablesForBatchObs);try{for(n.s();!(e=n.n()).done;){var i=e.value,r=this._globalVariables.get(i);r?this.variableChangedEvent(i,r):O("currentValue")}}catch(t){n.e(t)}finally{n.f()}this._changedVariablesForBatchObs=null}}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"$",value:function(t,e){if(void 0===e){var n=null;return null!==this.patch&&(n=this.patch.TryGetGlobal(t,null)).exists?n.result.valueObject:(void 0===(n=this._globalVariables.get(t))&&(n=this._defaultGlobalVariables.get(t)),void 0!==n?n.valueObject:null)}if(void 0===this._defaultGlobalVariables.get(t))throw new I("Cannot assign to a variable ("+t+") that hasn't been declared in the story");var i=V.Create(e);if(null==i)throw null==e?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"ApplyPatch",value:function(){if(null===this.patch)return O("this.patch");var t,e=m(this.patch.globals);try{for(e.s();!(t=e.n()).done;){var n=v(t.value,2),i=n[0],r=n[1];this._globalVariables.set(i,r)}}catch(t){e.e(t)}finally{e.f()}if(null!==this._changedVariablesForBatchObs){var a,s=m(this.patch.changedVariables);try{for(s.s();!(a=s.n()).done;){var o=a.value;this._changedVariablesForBatchObs.add(o)}}catch(t){s.e(t)}finally{s.f()}}this.patch=null}},{key:"SetJsonToken",value:function(t){this._globalVariables.clear();var e,n=m(this._defaultGlobalVariables);try{for(n.s();!(e=n.n()).done;){var i=v(e.value,2),r=i[0],a=i[1],s=t[r];if(void 0!==s){var o=at.JTokenToRuntimeObject(s);if(null===o)return O("tokenInkObject");this._globalVariables.set(r,o)}else this._globalVariables.set(r,a)}}catch(t){n.e(t)}finally{n.f()}}},{key:"WriteJson",value:function(e){e.WriteObjectStart();var n,i=m(this._globalVariables);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,2),a=r[0],s=r[1],o=a,u=s;if(t.dontSaveDefaultValues&&this._defaultGlobalVariables.has(o)){var l=this._defaultGlobalVariables.get(o);if(this.RuntimeObjectsEqual(u,l))continue}e.WritePropertyStart(o),at.WriteRuntimeObject(e,u),e.WritePropertyEnd()}}catch(t){i.e(t)}finally{i.f()}e.WriteObjectEnd()}},{key:"RuntimeObjectsEqual",value:function(t,e){if(null===t)return O("obj1");if(null===e)return O("obj2");if(t.constructor!==e.constructor)return!1;var n=b(t,L);if(null!==n)return n.value===w(e,L).value;var i=b(t,R);if(null!==i)return i.value===w(e,R).value;var r=b(t,j);if(null!==r)return r.value===w(e,j).value;var a=b(t,V),s=b(e,V);if(null!==a&&null!==s)return _(a.valueObject)&&_(s.valueObject)?a.valueObject.Equals(s.valueObject):a.valueObject===s.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}},{key:"GetVariableWithName",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=this.GetRawVariableWithName(t,e),i=b(n,M);return null!==i&&(n=this.ValueAtVariablePointer(i)),n}},{key:"TryGetDefaultVariableValue",value:function(t){var e=F(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}},{key:"GlobalVariableExistsWithName",value:function(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}},{key:"GetRawVariableWithName",value:function(t,e){if(0==e||-1==e){var n=null;if(null!==this.patch&&(n=this.patch.TryGetGlobal(t,null)).exists)return n.result;if((n=F(this._globalVariables,t,null)).exists)return n.result;if(null!==this._defaultGlobalVariables&&(n=F(this._defaultGlobalVariables,t,null)).exists)return n.result;if(null===this._listDefsOrigin)return O("VariablesState._listDefsOrigin");var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return this._callStack.GetTemporaryVariableWithName(t,e)}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName;if(null===n)return O("name");var i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n),t.isNewDeclaration){var a=b(e,M);null!==a&&(e=this.ResolveVariablePointer(a))}else{var s=null;do{null!=(s=b(this.GetRawVariableWithName(n,i),M))&&(n=s.variableName,r=0==(i=s.contextIndex))}while(null!=s)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=new Map(this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=w(t,G),i=w(e,G);n.value&&i.value&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n=null;if(null===this.patch&&(n=F(this._globalVariables,t,null)),null!==this.patch&&((n=this.patch.TryGetGlobal(t,null)).exists||(n=F(this._globalVariables,t,null))),G.RetainListOriginsForAssignment(n.result,e),null===t)return O("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==n&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return O("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=b(this.GetRawVariableWithName(t.variableName,e),M);return null!=n?n:new M(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}},{key:"ObserveVariableChange",value:function(t){this.variableChangedEventCallbacks.push(t)}}]),t}();ot.dontSaveDefaultValues=!0;var ut=function(){function t(e){n(this,t),this.seed=e%2147483647,this.seed<=0&&(this.seed+=2147483646)}return r(t,[{key:"next",value:function(){return this.seed=48271*this.seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),lt=function(){function t(){if(n(this,t),this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){var e=arguments[0];this._globals=new Map(e._globals),this._changedVariables=new Set(e._changedVariables),this._visitCounts=new Map(e._visitCounts),this._turnIndices=new Map(e._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}return r(t,[{key:"globals",get:function(){return this._globals}},{key:"changedVariables",get:function(){return this._changedVariables}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"TryGetGlobal",value:function(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}},{key:"SetGlobal",value:function(t,e){this._globals.set(t,e)}},{key:"AddChangedVariable",value:function(t){return this._changedVariables.add(t)}},{key:"TryGetVisitCount",value:function(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}},{key:"SetVisitCount",value:function(t,e){this._visitCounts.set(t,e)}},{key:"SetTurnIndex",value:function(t,e){this._turnIndices.set(t,e)}},{key:"TryGetTurnIndex",value:function(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}]),t}(),ht=function(){function t(){n(this,t)}return r(t,null,[{key:"TextToDictionary",value:function(e){return new t.Reader(e).ToDictionary()}},{key:"TextToArray",value:function(e){return new t.Reader(e).ToArray()}}]),t}();!function(t){var e=function(){function t(e){n(this,t),this._rootObject=JSON.parse(e)}return r(t,[{key:"ToDictionary",value:function(){return this._rootObject}},{key:"ToArray",value:function(){return this._rootObject}}]),t}();t.Reader=e;var i=function(){function e(){n(this,e),this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}return r(e,[{key:"WriteObject",value:function(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}},{key:"WriteObjectStart",value:function(){this.StartNewObject(!0);var e={};if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);var n=this._propertyNameStack.pop();this.currentCollection[n]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Object))}},{key:"WriteObjectEnd",value:function(){this.Assert(this.state===t.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}},{key:"WriteProperty",value:function(t,e){if(this.WritePropertyStart(t),arguments[1]instanceof Function)(0,arguments[1])(this);else{var n=arguments[1];this.Write(n)}this.WritePropertyEnd()}},{key:"WriteIntProperty",value:function(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}},{key:"WriteFloatProperty",value:function(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}},{key:"WritePropertyStart",value:function(e){this.Assert(this.state===t.Writer.State.Object),this._propertyNameStack.push(e),this.IncrementChildCount(),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property))}},{key:"WritePropertyEnd",value:function(){this.Assert(this.state===t.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}},{key:"WritePropertyNameStart",value:function(){this.Assert(this.state===t.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property)),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.PropertyName))}},{key:"WritePropertyNameEnd",value:function(){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}},{key:"WritePropertyNameInner",value:function(e){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=e}},{key:"WriteArrayStart",value:function(){this.StartNewObject(!0);var e=[];if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);var n=this._propertyNameStack.pop();this.currentCollection[n]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Array))}},{key:"WriteArrayEnd",value:function(){this.Assert(this.state===t.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}},{key:"Write",value:function(t){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null value")}},{key:"WriteBool",value:function(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(t))}},{key:"WriteInt",value:function(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}},{key:"WriteFloat",value:function(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}},{key:"WriteNull",value:function(){this.StartNewObject(!1),this._addToCurrentObject(null)}},{key:"WriteStringStart",value:function(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.String))}},{key:"WriteStringEnd",value:function(){this.Assert(this.state==t.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}},{key:"WriteStringInner",value:function(e){this.Assert(this.state===t.Writer.State.String),null!==e?this._currentString+=e:console.error("Warning: trying to write a null string")}},{key:"toString",value:function(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}},{key:"StartNewObject",value:function(e){e?this.Assert(this.state===t.Writer.State.None||this.state===t.Writer.State.Property||this.state===t.Writer.State.Array):this.Assert(this.state===t.Writer.State.Property||this.state===t.Writer.State.Array),this.state===t.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==t.Writer.State.Array&&this.state!==t.Writer.State.Property||this.IncrementChildCount()}},{key:"state",get:function(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:t.Writer.State.None}},{key:"childCount",get:function(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}},{key:"currentCollection",get:function(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}},{key:"currentPropertyName",get:function(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}},{key:"IncrementChildCount",value:function(){this.Assert(this._stateStack.length>0);var t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}},{key:"Assert",value:function(t){if(!t)throw Error("Assert failed while writing JSON")}},{key:"_addToCurrentObject",value:function(e){this.Assert(null!==this.currentCollection),this.state===t.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(e)):this.state===t.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=e,this._propertyNameStack.pop())}}]),e}();t.Writer=i,function(e){var i;(i=e.State||(e.State={}))[i.None=0]="None",i[i.Object=1]="Object",i[i.Array=2]="Array",i[i.Property=3]="Property",i[i.PropertyName=4]="PropertyName",i[i.String=5]="String";var a=r((function e(i){n(this,e),this.type=t.Writer.State.None,this.childCount=0,this.type=i}));e.StateElement=a}(i=t.Writer||(t.Writer={}))}(ht||(ht={}));var ct,ft,vt,dt=function(){function t(){n(this,t);var e=arguments[0],i=arguments[1];if(this.name=e,this.callStack=new st(i),arguments[2]){var r=arguments[2];this.callStack.SetJsonToken(r.callstack,i),this.outputStream=at.JArrayToRuntimeObjList(r.outputStream),this.currentChoices=at.JArrayToRuntimeObjList(r.currentChoices);var a=r.choiceThreads;void 0!==a&&this.LoadFlowChoiceThreads(a,i)}else this.outputStream=[],this.currentChoices=[]}return r(t,[{key:"WriteJson",value:function(t){var e=this;t.WriteObjectStart(),t.WriteProperty("callstack",(function(t){return e.callStack.WriteJson(t)})),t.WriteProperty("outputStream",(function(t){return at.WriteListRuntimeObjs(t,e.outputStream)}));var n,i=!1,r=m(this.currentChoices);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(null===a.threadAtGeneration)return O("c.threadAtGeneration");a.originalThreadIndex=a.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(a.originalThreadIndex)&&(i||(i=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(a.originalThreadIndex),a.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}}catch(t){r.e(t)}finally{r.f()}i&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("currentChoices",(function(t){t.WriteArrayStart();var n,i=m(e.currentChoices);try{for(i.s();!(n=i.n()).done;){var r=n.value;at.WriteChoice(t,r)}}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd()})),t.WriteObjectEnd()}},{key:"LoadFlowChoiceThreads",value:function(t,e){var n,i=m(this.currentChoices);try{for(i.s();!(n=i.n()).done;){var r=n.value,a=this.callStack.ThreadWithIndex(r.originalThreadIndex);if(null!==a)r.threadAtGeneration=a.Copy();else{var s=t["".concat(r.originalThreadIndex)];r.threadAtGeneration=new st.Thread(s,e)}}}catch(t){i.e(t)}finally{i.f()}}}]),t}(),pt=function(){function e(t){n(this,e),this.kInkSaveStateVersion=9,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=J.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this.story=t,this._currentFlow=new dt(this.kDefaultFlowName,t),this.OutputStreamDirty(),this._evaluationStack=[],this._variablesState=new ot(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;var i=(new Date).getTime();this.storySeed=new ut(i).next()%100,this.previousRandom=0,this.GoToStart()}return r(e,[{key:"ToJson",value:function(){var t=new ht.Writer;return this.WriteJson(t),t.toString()}},{key:"toJson",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.ToJson(t)}},{key:"LoadJson",value:function(t){var e=ht.TextToDictionary(t);this.LoadJsonObj(e),null!==this.onDidLoadState&&this.onDidLoadState()}},{key:"VisitCountAtPathString",value:function(t){var e;if(null!==this._patch){var n=this.story.ContentAtPath(new S(t)).container;if(null===n)throw new Error("Content at path not found: "+t);if((e=this._patch.TryGetVisitCount(n,0)).exists)return e.result}return(e=F(this._visitCounts,t,null)).exists?e.result:0}},{key:"VisitCountForContainer",value:function(t){if(null===t)return O("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){var e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}var n=t.path.toString(),i=F(this._visitCounts,n,null);return i.exists?i.result:0}},{key:"IncrementVisitCountForContainer",value:function(t){if(null!==this._patch){var e=this.VisitCountForContainer(t);return e++,void this._patch.SetVisitCount(t,e)}var n=t.path.toString(),i=F(this._visitCounts,n,null);i.exists?this._visitCounts.set(n,i.result+1):this._visitCounts.set(n,1)}},{key:"RecordTurnIndexVisitToContainer",value:function(t){if(null===this._patch){var e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}else this._patch.SetTurnIndex(t,this.currentTurnIndex)}},{key:"TurnsSinceForContainer",value:function(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){var e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}var n=t.path.toString(),i=F(this._turnIndices,n,0);return i.exists?this.currentTurnIndex-i.result:-1}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"outputStream",get:function(){return this._currentFlow.outputStream}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentFlow.currentChoices}},{key:"generatedChoices",get:function(){return this._currentFlow.currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"variablesState",get:function(){return this._variablesState},set:function(t){this._variablesState=t}},{key:"callStack",get:function(){return this._currentFlow.callStack}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex},set:function(t){this._currentTurnIndex=t}},{key:"currentPathString",get:function(){var t=this.currentPointer;return t.isNull?null:null===t.path?O("pointer.path"):t.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(t){this.callStack.currentElement.currentPointer=t.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(t){this.callStack.currentThread.previousPointer=t.copy()}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&this.currentWarnings.length>0}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t,e=new A,n=m(this.outputStream);try{for(n.s();!(t=n.n()).done;){var i=b(t.value,D);null!==i&&e.Append(i.value)}}catch(t){n.e(t)}finally{n.f()}this._currentText=this.CleanOutputWhitespace(e.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"CleanOutputWhitespace",value:function(t){for(var e=new A,n=-1,i=0,r=0;r<t.length;r++){var a=t.charAt(r),s=" "==a||"\t"==a;s&&-1==n&&(n=r),s||("\n"!=a&&n>0&&n!=i&&e.Append(" "),n=-1),"\n"==a&&(i=r+1),s||e.Append(a)}return e.toString()}},{key:"currentTags",get:function(){if(this._outputStreamTagsDirty){this._currentTags=[];var t,e=m(this.outputStream);try{for(e.s();!(t=e.n()).done;){var n=b(t.value,et);null!==n&&this._currentTags.push(n.text)}}catch(t){e.e(t)}finally{e.f()}this._outputStreamTagsDirty=!1}return this._currentTags}},{key:"currentFlowName",get:function(){return this._currentFlow.name}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=J.StartOf(this.story.mainContentContainer)}},{key:"SwitchFlow_Internal",value:function(t){if(null===t)throw new Error("Must pass a non-null string to Story.SwitchFlow");if(null===this._namedFlows&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),t!==this._currentFlow.name){var e,n=F(this._namedFlows,t,null);n.exists?e=n.result:(e=new dt(t,this.story),this._namedFlows.set(t,e)),this._currentFlow=e,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}}},{key:"SwitchToDefaultFlow_Internal",value:function(){null!==this._namedFlows&&this.SwitchFlow_Internal(this.kDefaultFlowName)}},{key:"RemoveFlow_Internal",value:function(t){if(null===t)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(t===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===t&&this.SwitchToDefaultFlow_Internal(),null===this._namedFlows)return O("this._namedFlows");this._namedFlows.delete(t)}},{key:"CopyAndStartPatching",value:function(){var t,n,i,r,a,s=new e(this.story);if(s._patch=new lt(this._patch),s._currentFlow.name=this._currentFlow.name,s._currentFlow.callStack=new st(this._currentFlow.callStack),(t=s._currentFlow.currentChoices).push.apply(t,d(this._currentFlow.currentChoices)),(n=s._currentFlow.outputStream).push.apply(n,d(this._currentFlow.outputStream)),s.OutputStreamDirty(),null!==this._namedFlows){s._namedFlows=new Map;var o,u=m(this._namedFlows);try{for(u.s();!(o=u.n()).done;){var l=v(o.value,2),h=l[0],c=l[1];s._namedFlows.set(h,c)}}catch(t){u.e(t)}finally{u.f()}s._namedFlows.set(this._currentFlow.name,s._currentFlow)}return this.hasError&&(s._currentErrors=[],(r=s._currentErrors).push.apply(r,d(this.currentErrors||[]))),this.hasWarning&&(s._currentWarnings=[],(a=s._currentWarnings).push.apply(a,d(this.currentWarnings||[]))),s.variablesState=this.variablesState,s.variablesState.callStack=s.callStack,s.variablesState.patch=s._patch,(i=s.evaluationStack).push.apply(i,d(this.evaluationStack)),this.divertedPointer.isNull||(s.divertedPointer=this.divertedPointer.copy()),s.previousPointer=this.previousPointer.copy(),s._visitCounts=this._visitCounts,s._turnIndices=this._turnIndices,s.currentTurnIndex=this.currentTurnIndex,s.storySeed=this.storySeed,s.previousRandom=this.previousRandom,s.didSafeExit=this.didSafeExit,s}},{key:"RestoreAfterPatch",value:function(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}},{key:"ApplyAnyPatch",value:function(){if(null!==this._patch){this.variablesState.ApplyPatch();var t,e=m(this._patch.visitCounts);try{for(e.s();!(t=e.n()).done;){var n=v(t.value,2),i=n[0],r=n[1];this.ApplyCountChanges(i,r,!0)}}catch(t){e.e(t)}finally{e.f()}var a,s=m(this._patch.turnIndices);try{for(s.s();!(a=s.n()).done;){var o=v(a.value,2),u=o[0],l=o[1];this.ApplyCountChanges(u,l,!1)}}catch(t){s.e(t)}finally{s.f()}this._patch=null}}},{key:"ApplyCountChanges",value:function(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}},{key:"WriteJson",value:function(e){var n=this;if(e.WriteObjectStart(),e.WritePropertyStart("flows"),e.WriteObjectStart(),null!==this._namedFlows){var i,r=m(this._namedFlows);try{var a=function(){var t=v(i.value,2),n=t[0],r=t[1];e.WriteProperty(n,(function(t){return r.WriteJson(t)}))};for(r.s();!(i=r.n()).done;)a()}catch(t){r.e(t)}finally{r.f()}}else e.WriteProperty(this._currentFlow.name,(function(t){return n._currentFlow.WriteJson(t)}));if(e.WriteObjectEnd(),e.WritePropertyEnd(),e.WriteProperty("currentFlowName",this._currentFlow.name),e.WriteProperty("variablesState",(function(t){return n.variablesState.WriteJson(t)})),e.WriteProperty("evalStack",(function(t){return at.WriteListRuntimeObjs(t,n.evaluationStack)})),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return O("divertedPointer");e.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}e.WriteProperty("visitCounts",(function(t){return at.WriteIntDictionary(t,n._visitCounts)})),e.WriteProperty("turnIndices",(function(t){return at.WriteIntDictionary(t,n._turnIndices)})),e.WriteIntProperty("turnIdx",this.currentTurnIndex),e.WriteIntProperty("storySeed",this.storySeed),e.WriteIntProperty("previousRandom",this.previousRandom),e.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),e.WriteIntProperty("inkFormatVersion",t.Story.inkVersionCurrent),e.WriteObjectEnd()}},{key:"LoadJsonObj",value:function(t){var e=t,n=e.inkSaveVersion;if(null==n)throw new Error("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");var i=e.flows;if(null!=i){var r=i;1===Object.keys(r).length?this._namedFlows=null:null===this._namedFlows?this._namedFlows=new Map:this._namedFlows.clear();for(var a=0,s=Object.entries(r);a<s.length;a++){var o=v(s[a],2),u=o[0],l=o[1],h=new dt(u,this.story,l);if(1===Object.keys(r).length)this._currentFlow=new dt(u,this.story,l);else{if(null===this._namedFlows)return O("this._namedFlows");this._namedFlows.set(u,h)}}if(null!=this._namedFlows&&this._namedFlows.size>1){var c=e.currentFlowName;this._currentFlow=this._namedFlows.get(c)}}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(e.callstackThreads,this.story),this._currentFlow.outputStream=at.JArrayToRuntimeObjList(e.outputStream),this._currentFlow.currentChoices=at.JArrayToRuntimeObjList(e.currentChoices);var f=e.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(f,this.story)}this.OutputStreamDirty(),this.variablesState.SetJsonToken(e.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=at.JArrayToRuntimeObjList(e.evalStack);var d=e.currentDivertTarget;if(null!=d){var p=new S(d.toString());this.divertedPointer=this.story.PointerAtPath(p)}this._visitCounts=at.JObjectToIntDictionary(e.visitCounts),this._turnIndices=at.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom)}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.outputStream.length=0,null!==e&&(t=this.outputStream).push.apply(t,d(e)),this.OutputStreamDirty()}},{key:"PushToOutputStream",value:function(t){var e=b(t,D);if(null!==e){var n=this.TrySplittingHeadTailWhitespace(e);if(null!==n){var i,r=m(n);try{for(r.s();!(i=r.n()).done;){var a=i.value;this.PushToOutputStreamIndividual(a)}}catch(t){r.e(t)}finally{r.f()}return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){var e=t.value;if(null===e)return O("single.value");for(var n=-1,i=-1,r=0;r<e.length;r++){var a=e[r];if("\n"!=a){if(" "==a||"\t"==a)continue;break}-1==n&&(n=r),i=r}for(var s=-1,o=-1,u=e.length-1;u>=0;u--){var l=e[u];if("\n"!=l){if(" "==l||"\t"==l)continue;break}-1==s&&(s=u),o=u}if(-1==n&&-1==s)return null;var h=[],c=0,f=e.length;if(-1!=n){if(n>0){var v=new D(e.substring(0,n));h.push(v)}h.push(new D("\n")),c=i+1}if(-1!=s&&(f=o),f>c){var d=e.substring(c,f-c);h.push(new D(d))}if(-1!=s&&o>i&&(h.push(new D("\n")),s<e.length-1)){var p=e.length-s-1,y=new D(e.substring(s+1,p));h.push(y)}return h}},{key:"PushToOutputStreamIndividual",value:function(t){var e=b(t,z),n=b(t,D),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){var r=-1,a=this.callStack.currentElement;a.type==K.Function&&(r=a.functionStartInOutputStream);for(var s=-1,o=this.outputStream.length-1;o>=0;o--){var u=this.outputStream[o],l=u instanceof q?u:null;if(null!=(u instanceof z?u:null)){s=o;break}if(null!=l&&l.commandType==q.CommandType.BeginString){o>=r&&(r=-1);break}}if(-1!=(-1!=s&&-1!=r?Math.min(r,s):-1!=s?s:r)){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(s>-1&&this.RemoveExistingGlue(),r>-1))for(var h=this.callStack.elements,c=h.length-1;c>=0;c--){var f=h[c];if(f.type!=K.Function)break;f.functionStartInOutputStream=-1}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===t)return O("obj");this.outputStream.push(t),this.OutputStreamDirty()}}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var t=-1,e=this.outputStream.length-1;e>=0;){var n=this.outputStream[e],i=b(n,q),r=b(n,D);if(null!=i||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this.outputStream.length;)b(this.outputStream[e],D)?this.outputStream.splice(e,1):e++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this.outputStream.length-1;t>=0;t--){var e=this.outputStream[t];if(e instanceof z)this.outputStream.splice(t,1);else if(e instanceof q)break}this.OutputStreamDirty()}},{key:"outputStreamEndsInNewline",get:function(){if(this.outputStream.length>0)for(var t=this.outputStream.length-1;t>=0&&!(this.outputStream[t]instanceof q);t--){var e=this.outputStream[t];if(e instanceof D){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){var t,e=m(this.outputStream);try{for(e.s();!(t=e.n()).done;)if(t.value instanceof D)return!0}catch(t){e.e(t)}finally{e.f()}return!1}},{key:"inStringEvaluation",get:function(){for(var t=this.outputStream.length-1;t>=0;t--){var e=b(this.outputStream[t],q);if(e instanceof q&&e.commandType==q.CommandType.BeginString)return!0}return!1}},{key:"PushEvaluationStack",value:function(t){var e=b(t,G);if(e){var n=e.value;if(null===n)return O("rawList");if(null!=n.originNames){n.origins||(n.origins=[]),n.origins.length=0;var i,r=m(n.originNames);try{for(r.s();!(i=r.n()).done;){var a=i.value;if(null===this.story.listDefinitions)return O("StoryState.story.listDefinitions");var s=this.story.listDefinitions.TryListGetDefinition(a,null);if(null===s.result)return O("StoryState def.result");n.origins.indexOf(s.result)<0&&n.origins.push(s.result)}}catch(t){r.e(t)}finally{r.f()}}}if(null===t)return O("obj");this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(void 0===t)return C(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return C(this.evaluationStack.splice(this.evaluationStack.length-t,t))}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"ForceEnd",value:function(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=J.Null,this.previousPointer=J.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){g.Assert(this.callStack.currentElement.type==K.Function);var t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(var e=this.outputStream.length-1;e>=t;e--){var n=this.outputStream[e],i=b(n,D),r=b(n,q);if(null!=i){if(r)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this.outputStream.splice(e,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==K.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}},{key:"SetChosenPath",value:function(t,e){this._currentFlow.currentChoices.length=0;var n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this.currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(t,e){this.callStack.Push(K.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=J.StartOf(t),this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!==t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e]||t[e]instanceof N)throw new Error((C(arguments[e]),"null"));this.PushEvaluationStack(V.Create(t[e]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==K.FunctionEvaluationFromGame&&(this.currentPointer=J.Null,this.didSafeExit=!0,!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=K.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);for(var t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;this.evaluationStack.length>t;){var n=this.PopEvaluationStack();null===e&&(e=n)}if(this.PopCallStack(K.FunctionEvaluationFromGame),e){if(e instanceof Y)return null;var i=w(e,V);return i.valueType==W.DivertTarget?i.valueObject.toString():i.valueObject}return null}},{key:"AddError",value:function(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}]),e}(),yt=function(){function t(){n(this,t),this.startTime=void 0}return r(t,[{key:"ElapsedMilliseconds",get:function(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}},{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}}]),t}();!function(t){t[t.Author=0]="Author",t[t.Warning=1]="Warning",t[t.Error=2]="Error"}(ct||(ct={})),Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t}),t.Story=function(t){a(s,t);var i=f(s);function s(){var t,e;n(this,s),(t=i.call(this)).inkVersionMinimumCompatible=18,t.onError=null,t.onDidContinue=null,t.onMakeChoice=null,t.onEvaluateFunction=null,t.onCompleteEvaluateFunction=null,t.onChoosePathString=null,t._prevContainers=[],t.allowExternalFunctionFallbacks=!1,t._listDefinitions=null,t._variableObservers=null,t._hasValidatedExternals=!1,t._temporaryEvaluationContainer=null,t._asyncContinueActive=!1,t._stateSnapshotAtLastNewline=null,t._sawLookaheadUnsafeFunctionAfterNewline=!1,t._recursiveContinueCount=0,t._asyncSaving=!1,t._profiler=null;var r=null,a=null;if(arguments[0]instanceof U)e=arguments[0],void 0!==arguments[1]&&(r=arguments[1]),t._mainContentContainer=e;else if("string"==typeof arguments[0]){var o=arguments[0];a=ht.TextToDictionary(o)}else a=arguments[0];if(null!=r&&(t._listDefinitions=new rt(r)),t._externals=new Map,null!==a){var u=a,l=u.inkVersion;if(null==l)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");var h=parseInt(l);if(h>s.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(h<t.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");h!=s.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var c,f=u.root;if(null==f)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(c=u.listDefs)&&(t._listDefinitions=at.JTokenToListDefinitions(c)),t._mainContentContainer=w(at.JTokenToRuntimeObject(f),U),t.ResetState()}return t}return r(s,[{key:"currentChoices",get:function(){var t=[];if(null===this._state)return O("this._state");var e,n=m(this._state.currentChoices);try{for(n.s();!(e=n.n()).done;){var i=e.value;i.isInvisibleDefault||(i.index=t.length,t.push(i))}}catch(t){n.e(t)}finally{n.f()}return t}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"currentFlowName",get:function(){return this.state.currentFlowName}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJson",value:function(t){var e=this,n=!1;if(t||(n=!0,t=new ht.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",s.inkVersionCurrent),t.WriteProperty("root",(function(t){return at.WriteRuntimeContainer(t,e._mainContentContainer)})),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();var i,r=m(this._listDefinitions.lists);try{for(r.s();!(i=r.n()).done;){var a=i.value;t.WritePropertyStart(a.name),t.WriteObjectStart();var o,u=m(a.items);try{for(u.s();!(o=u.n()).done;){var l=v(o.value,2),h=l[0],c=l[1],f=x.fromSerializedKey(h),d=c;t.WriteIntProperty(f.itemName,d)}}catch(t){u.e(t)}finally{u.f()}t.WriteObjectEnd(),t.WritePropertyEnd()}}catch(t){r.e(t)}finally{r.f()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),n)return t.toString()}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new pt(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){if(null===this._state)return O("this._state");this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return O("this._state");this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent.get("global decl")){var t=this.state.currentPointer.copy();this.ChoosePath(new S("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}},{key:"SwitchFlow",value:function(t){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+t);this.state.SwitchFlow_Internal(t)}},{key:"RemoveFlow",value:function(t){this.state.RemoveFlow_Internal(t)}},{key:"SwitchToDefaultFlow",value:function(){this.state.SwitchToDefaultFlow_Internal()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"ContinueAsync",value:function(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}},{key:"ContinueInternal",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;null!=this._profiler&&this._profiler.PreContinue();var e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var n=new yt;n.Start();var i=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof I))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);if(n.Stop(),!i&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(K.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(K.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1,null!==this.onDidContinue&&this.onDidContinue()),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(null===this.onError){var r=new A;throw r.Append("Ink had "),this.state.hasError&&(r.Append("".concat(this.state.currentErrors.length)),r.Append(1==this.state.currentErrors.length?" error":"errors"),this.state.hasWarning&&r.Append(" and ")),this.state.hasWarning&&(r.Append("".concat(this.state.currentWarnings.length)),r.Append(1==this.state.currentWarnings.length?" warning":"warnings"),this.state.hasWarning&&r.Append(" and ")),r.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),r.Append(this.state.hasError?this.state.currentErrors[0]:this.state.currentWarnings[0]),new I(r.toString())}if(this.state.hasError){var a,s=m(this.state.currentErrors);try{for(s.s();!(a=s.n()).done;){var o=a.value;this.onError(o,ct.Error)}}catch(o){s.e(o)}finally{s.f()}}if(this.state.hasWarning){var u,l=m(this.state.currentWarnings);try{for(l.s();!(u=l.n()).done;){var h=u.value;this.onError(h,ct.Warning)}}catch(o){l.e(o)}finally{l.f()}}this.ResetErrors()}}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return O("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return O("this.state.currentTags");var t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==s.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;t==s.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(t,e,n,i){if(null===t)return O("prevText");if(null===e)return O("currText");var r=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&r)return s.OutputStateChange.NoChange;if(!r)return s.OutputStateChange.NewlineRemoved;if(i>n)return s.OutputStateChange.ExtendedBeyondNewline;for(var a=t.length;a<e.length;a++){var o=e.charAt(a);if(" "!=o&&"\t"!=o)return s.OutputStateChange.ExtendedBeyondNewline}return s.OutputStateChange.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new A;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"KnotContainerWithName",value:function(t){var e=this.mainContentContainer.namedContent.get(t);return e instanceof U?e:null}},{key:"PointerAtPath",value:function(t){if(0==t.length)return J.Null;var e=new J,n=t.length,i=null;return null===t.lastComponent?O("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}},{key:"StateSnapshot",value:function(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}},{key:"RestoreStateSnapshot",value:function(){null===this._stateSnapshotAtLastNewline&&O("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}},{key:"DiscardSnapshot",value:function(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}},{key:"CopyStateForBackgroundThreadSave",value:function(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");var t=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,t}},{key:"BackgroundSaveComplete",value:function(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}},{key:"Step",value:function(){var t=!0,e=this.state.currentPointer.copy();if(!e.isNull){for(var n=b(e.Resolve(),U);n&&(this.VisitContainer(n,!0),0!=n.content.length);)n=b((e=J.StartOf(n)).Resolve(),U);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);var i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(!this.state.currentPointer.isNull){r&&(t=!1);var a=b(i,X);if(a){var s=this.ProcessChoice(a);s&&this.state.generatedChoices.push(s),i=null,t=!1}if(i instanceof U&&(t=!1),t){var o=b(i,M);if(o&&-1==o.contextIndex){var u=this.state.callStack.ContextForVariableNamed(o.variableName);i=new M(o.variableName,u)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();var l=b(i,q);l&&l.commandType==q.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(!e.isNull&&-1!=e.index){if(this._prevContainers.length=0,!t.isNull)for(var n=b(t.Resolve(),U)||b(t.container,U);n;)this._prevContainers.push(n),n=b(n.parent,U);var i=e.Resolve();if(null!=i)for(var r=b(i.parent,U),a=!0;r&&(this._prevContainers.indexOf(r)<0||r.countingAtStartOnly);){var s=r.content.length>0&&i==r.content[0]&&a;s||(a=!1),this.VisitContainer(r,s),i=r,r=b(r.parent,U)}}}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(e=!1)}var i="",r="";if(t.hasChoiceOnlyContent&&(r=w(this.state.PopEvaluationStack(),D).value||""),t.hasStartContent&&(i=w(this.state.PopEvaluationStack(),D).value||""),t.onceOnly&&this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;var a=new nt;return a.targetPath=t.pathOnChoice,a.sourcePath=t.path.toString(),a.isInvisibleDefault=t.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.ForkThread(),a.text=(i+r).replace(/^[ \t]+|[ \t]+$/g,""),a}},{key:"IsTruthy",value:function(t){if(t instanceof V){var e=t;if(e instanceof B){var n=e;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof Z){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var i=e.variableDivertName,r=this.state.variablesState.GetVariableWithName(i);if(null==r)this.Error("Tried to divert using a target from a variable that could not be found ("+i+")");else if(!(r instanceof B)){var a=b(r,R),s="Tried to divert to a target from a variable, but the variable ("+i+") didn't contain a divert target, it ";a instanceof R&&0==a.value?s+="was empty/null (the value 0).":s+="contained '"+r+"'.",this.Error(s)}var o=w(r,B);this.state.divertedPointer=this.PointerAtPath(o.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof q){var u=t;switch(u.commandType){case q.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case q.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case q.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var l=this.state.PopEvaluationStack();if(!(l instanceof Y)){var h=new D(l.toString());this.state.PushToOutputStream(h)}}break;case q.CommandType.NoOp:break;case q.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case q.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case q.CommandType.PopFunction:case q.CommandType.PopTunnel:var c=u.commandType==q.CommandType.PopFunction?K.Function:K.Tunnel,f=null;if(c==K.Tunnel){var v=this.state.PopEvaluationStack();null===(f=b(v,B))&&this.Assert(v instanceof Y,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==c&&this.state.callStack.canPop)this.state.PopCallStack(),f&&(this.state.divertedPointer=this.PointerAtPath(f.targetPath));else{var d=new Map;d.set(K.Function,"function return statement (~ return)"),d.set(K.Tunnel,"tunnel onwards statement (->->)");var p=d.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(p="end of flow (-> END or choice)");var y="Found "+d.get(c)+", when expected "+p;this.Error(y)}break;case q.CommandType.BeginString:this.state.PushToOutputStream(u),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case q.CommandType.EndString:for(var g=[],S=0,k=this.state.outputStream.length-1;k>=0;--k){var C=this.state.outputStream[k];S++;var _=b(C,q);if(_&&_.commandType==q.CommandType.BeginString)break;C instanceof D&&g.push(C)}this.state.PopFromOutputStream(S),g=g.reverse();var E,T=new A,P=m(g);try{for(P.s();!(E=P.n()).done;){var F=E.value;T.Append(F.toString())}}catch(t){P.e(t)}finally{P.f()}this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new D(T.toString()));break;case q.CommandType.ChoiceCount:var W=this.state.generatedChoices.length;this.state.PushEvaluationStack(new R(W));break;case q.CommandType.Turns:this.state.PushEvaluationStack(new R(this.state.currentTurnIndex+1));break;case q.CommandType.TurnsSince:case q.CommandType.ReadCount:var L=this.state.PopEvaluationStack();if(!(L instanceof B)){var j="";L instanceof R&&(j=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+L+j);break}var M,H=w(L,B),z=b(this.ContentAtPath(H.targetPath).correctObj,U);null!=z?M=u.commandType==q.CommandType.TurnsSince?this.state.TurnsSinceForContainer(z):this.state.VisitCountForContainer(z):(M=u.commandType==q.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+u.toString()+" lookup at "+H.targetPath.toString())),this.state.PushEvaluationStack(new R(M));break;case q.CommandType.Random:var X=b(this.state.PopEvaluationStack(),R),et=b(this.state.PopEvaluationStack(),R);if(null==et||et instanceof R==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==X||et instanceof R==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===X.value)return O("maxInt.value");if(null===et.value)return O("minInt.value");var nt=X.value-et.value+1;(!isFinite(nt)||nt>Number.MAX_SAFE_INTEGER)&&(nt=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),nt<=0&&this.Error("RANDOM was called with minimum as "+et.value+" and maximum as "+X.value+". The maximum must be larger");var it=this.state.storySeed+this.state.previousRandom,rt=new ut(it).next(),at=rt%nt+et.value;this.state.PushEvaluationStack(new R(at)),this.state.previousRandom=rt;break;case q.CommandType.SeedRandom:var st=b(this.state.PopEvaluationStack(),R);if(null==st||st instanceof R==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===st.value)return O("minInt.value");this.state.storySeed=st.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new Y);break;case q.CommandType.VisitIndex:var ot=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new R(ot));break;case q.CommandType.SequenceShuffleIndex:var lt=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new R(lt));break;case q.CommandType.StartThread:break;case q.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=J.Null);break;case q.CommandType.End:this.state.ForceEnd();break;case q.CommandType.ListFromInt:var ht=b(this.state.PopEvaluationStack(),R),ct=w(this.state.PopEvaluationStack(),D);if(null===ht)throw new I("Passed non-integer when creating a list element from a numerical value.");var ft=null;if(null===this.listDefinitions)return O("this.listDefinitions");var vt=this.listDefinitions.TryListGetDefinition(ct.value,null);if(!vt.exists)throw new I("Failed to find LIST called "+ct.value);if(null===ht.value)return O("minInt.value");var dt=vt.result.TryGetItemWithValue(ht.value,x.Null);dt.exists&&(ft=new G(dt.result,ht.value)),null==ft&&(ft=new G),this.state.PushEvaluationStack(ft);break;case q.CommandType.ListRange:var pt=b(this.state.PopEvaluationStack(),V),yt=b(this.state.PopEvaluationStack(),V),mt=b(this.state.PopEvaluationStack(),G);if(null===mt||null===yt||null===pt)throw new I("Expected list, minimum and maximum for LIST_RANGE");if(null===mt.value)return O("targetList.value");var gt=mt.value.ListWithSubRange(yt.valueObject,pt.valueObject);this.state.PushEvaluationStack(new G(gt));break;case q.CommandType.ListRandom:var St=this.state.PopEvaluationStack();if(null===St)throw new I("Expected list for LIST_RANDOM");var bt=St.value,wt=null;if(null===bt)throw O("list");if(0==bt.Count)wt=new N;else{for(var kt=this.state.storySeed+this.state.previousRandom,Ct=new ut(kt).next(),_t=Ct%bt.Count,Et=bt.entries(),Tt=0;Tt<=_t-1;Tt++)Et.next();var Ot=Et.next().value,Pt={Key:x.fromSerializedKey(Ot[0]),Value:Ot[1]};if(null===Pt.Key.originName)return O("randomItem.Key.originName");(wt=new N(Pt.Key.originName,this)).Add(Pt.Key,Pt.Value),this.state.previousRandom=Ct}this.state.PushEvaluationStack(new G(wt));break;default:this.Error("unhandled ControlCommand: "+u)}return!0}if(t instanceof $){var At=t,xt=this.state.PopEvaluationStack();return this.state.variablesState.Assign(At,xt),!0}if(t instanceof Q){var Nt=t,It=null;if(null!=Nt.pathForCount){var Ft=Nt.containerForCount,Wt=this.state.VisitCountForContainer(Ft);It=new R(Wt)}else null==(It=this.state.variablesState.GetVariableWithName(Nt.name))&&(this.Warning("Variable not found: '"+Nt.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),It=new R(0));return this.state.PushEvaluationStack(It),!0}if(t instanceof tt){var Vt=t,Lt=this.state.PopEvaluationStack(Vt.numberOfParameters),Rt=Vt.Call(Lt);return this.state.PushEvaluationStack(Rt),!0}return!1}},{key:"ChoosePathString",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),null!==this.onChoosePathString&&this.onChoosePathString(t,n),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==K.Function){var i="",r=this.state.callStack.currentElement.currentPointer.container;throw null!=r&&(i="("+r.path.toString()+") "),new Error("Story was running a function "+i+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new S(t))}},{key:"IfAsyncWeCant",value:function(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}},{key:"ChoosePath",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){var e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");var n=e[t];return null!==this.onMakeChoice&&this.onMakeChoice(n),null===n.threadAtGeneration?O("choiceToChoose.threadAtGeneration"):null===n.targetPath?O("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}},{key:"HasFunction",value:function(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==this.onEvaluateFunction&&this.onEvaluateFunction(t,e),this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");var i=this.KnotContainerWithName(t);if(null==i)throw new Error("Function doesn't exist: '"+t+"'");var r=[];r.push.apply(r,d(this.state.outputStream)),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);for(var a=new A;this.canContinue;)a.Append(this.Continue());var s=a.toString();this._state.ResetOutput(r);var o=this.state.CompleteFunctionEvaluationFromGame();return null!=this.onCompleteEvaluateFunction&&this.onCompleteEvaluateFunction(t,e,s,o),n?{returned:o,output:s}:o}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(K.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,n){if(null===t)return O("funcName");var i=this._externals.get(t),r=null,a=void 0!==i;if(!a||i.lookAheadSafe||null===this._stateSnapshotAtLastNewline){if(!a){if(this.allowExternalFunctionFallbacks)return r=this.KnotContainerWithName(t),this.Assert(null!==r,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(K.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=J.StartOf(r));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var s=[],o=0;o<n;++o){var u=w(this.state.PopEvaluationStack(),V).valueObject;s.push(u)}s.reverse();var l=i.function(s),h=null;null!=l?(h=V.Create(l),this.Assert(null!==h,"Could not create ink value from returned object of type "+e(l))):h=new Y,this.state.PushEvaluationStack(h)}else this._sawLookaheadUnsafeFunctionAfterNewline=!0}},{key:"BindExternalFunctionGeneral",value:function(t,e,n){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,{function:e,lookAheadSafe:n})}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunction",value:function(t,e,n){var i=this;this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,(function(t){i.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");for(var n=[],r=0,a=t.length;r<a;r++)n[r]=i.TryCoerce(t[r]);return e.apply(null,n)}),n)}},{key:"UnbindExternalFunction",value:function(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}},{key:"ValidateExternalBindings",value:function(){var t=null,e=null,n=arguments[1]||new Set;if(arguments[0]instanceof U&&(t=arguments[0]),arguments[0]instanceof P&&(e=arguments[0]),null===t&&null===e)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,0==n.size)this._hasValidatedExternals=!0;else{var i="Error: Missing function binding for external";i+=n.size>1?"s":"",i+=": '",i+=Array.from(n).join("', '"),i+="' ",i+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(i)}else if(null!=t){var r,a=m(t.content);try{for(a.s();!(r=a.n()).done;){var s=r.value;null!=s&&s.hasValidName||this.ValidateExternalBindings(s,n)}}catch(t){a.e(t)}finally{a.f()}var o,u=m(t.namedContent);try{for(u.s();!(o=u.n()).done;){var l=v(o.value,2)[1];this.ValidateExternalBindings(b(l,P),n)}}catch(t){u.e(t)}finally{u.f()}}else if(null!=e){var h=b(e,Z);if(h&&h.isExternal){var c=h.targetPathString;if(null===c)return O("name");this._externals.has(c)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(c)||n.add(c)}}}},{key:"ObserveVariable",value:function(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new Error("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(null!=e){if(this._variableObservers.has(e))if(null!=t){var n=this._variableObservers.get(e);null!=n&&(n.splice(n.indexOf(t),1),0===n.length&&this._variableObservers.delete(e))}else this._variableObservers.delete(e)}else if(null!=t){var i,r=m(this._variableObservers.keys());try{for(r.s();!(i=r.n()).done;){var a=i.value,s=this._variableObservers.get(a);null!=s&&(s.splice(s.indexOf(t),1),0===s.length&&this._variableObservers.delete(a))}}catch(t){r.e(t)}finally{r.f()}}}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!==this._variableObservers){var n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof V))throw new Error("Tried to get the value of a variable that isn't a standard type");var i,r=w(e,V),a=m(n);try{for(a.s();!(i=a.n()).done;)(0,i.value)(t,r.valueObject)}catch(t){a.e(t)}finally{a.f()}}}}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){var e=new S(t),n=this.ContentAtPath(e).container;if(null===n)return O("flowContainer");for(;;){var i=n.content[0];if(!(i instanceof U))break;n=i}var r,a=null,s=m(n.content);try{for(s.s();!(r=s.n()).done;){var o=b(r.value,et);if(!o)break;null==a&&(a=[]),a.push(o.text)}}catch(t){s.e(t)}finally{s.f()}return a}},{key:"BuildStringOfHierarchy",value:function(){var t=new A;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new A;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"NextContent",value:function(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=J.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){var t=!1;this.state.callStack.CanPop(K.Function)?(this.state.PopCallStack(K.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new Y),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return O("pointer.container");for(;e.index>=e.container.content.length;){t=!1;var n=b(e.container.parent,U);if(n instanceof U==0)break;var i=n.content.indexOf(e.container);if(-1==i)break;if((e=new J(n,i)).index++,t=!0,null===e.container)return O("pointer.container")}return t||(e=J.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter((function(t){return t.isInvisibleDefault}));if(0==e.length||t.length>e.length)return!1;var n=e[0];return null===n.targetPath?O("choice.targetPath"):null===n.threadAtGeneration?O("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,null!==this._stateSnapshotAtLastNewline&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(n.targetPath,!1),!0)}},{key:"NextSequenceShuffleIndex",value:function(){var t=b(this.state.PopEvaluationStack(),R);if(!(t instanceof R))return this.Error("expected number of elements in sequence for shuffle index"),0;var e=this.state.currentPointer.container;if(null===e)return O("seqContainer");if(null===t.value)return O("numElementsIntVal.value");var n=t.value,i=w(this.state.PopEvaluationStack(),R).value;if(null===i)return O("seqCount");for(var r=i/n,a=i%n,s=e.path.toString(),o=0,u=0,l=s.length;u<l;u++)o+=s.charCodeAt(u)||0;for(var h=o+r+this.state.storySeed,c=new ut(Math.floor(h)),f=[],v=0;v<n;++v)f.push(v);for(var d=0;d<=a;++d){var p=c.next()%f.length,y=f[p];if(f.splice(p,1),d==a)return y}throw new Error("Should never reach here")}},{key:"Error",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=new I(t);throw n.useEndLineNumber=e,n}},{key:"Warning",value:function(t){this.AddError(t,!0)}},{key:"AddError",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(null!=i){var a=n?i.endLineNumber:i.startLineNumber;t="RUNTIME "+r+": '"+i.fileName+"' line "+a+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}},{key:"Assert",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}},{key:"currentDebugMetadata",get:function(){var t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(var n=this.state.callStack.elements.length-1;n>=0;--n)if(!(e=this.state.callStack.elements[n].currentPointer).isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(var i=this.state.outputStream.length-1;i>=0;--i)if(null!==(t=this.state.outputStream[i].debugMetadata))return t;return null}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}]),s}(P),t.Story.inkVersionCurrent=20,(vt=(ft=t.Story||(t.Story={})).OutputStateChange||(ft.OutputStateChange={}))[vt.NoChange=0]="NoChange",vt[vt.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",vt[vt.NewlineRemoved=2]="NewlineRemoved",t.InkList=N,Object.defineProperty(t,"__esModule",{value:!0})}(e)},272:function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Actor=void 0;e.Actor=function(t){this.id=t,this.img=null,this.pos="left",this.name="",this.flipped=!1,this.time=1e3}},61:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Background=void 0;var i=n(655),r=n(679),a=n(593),s=function(){function t(){this.fade=0,this.imageA=null,this.imageB=null,this.overlayColor="#fff",this.overlayAlpha=0}return t.prototype.draw=function(t){t.globalAlpha=1-this.fade,this.imageA&&a.DrawUtils.drawFullScreenImage(t,this.imageA),t.globalAlpha=this.fade,this.imageB&&a.DrawUtils.drawFullScreenImage(t,this.imageB),this.overlayAlpha>0&&(t.globalAlpha=this.overlayAlpha,t.fillStyle=this.overlayColor,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalAlpha=1)},t.prototype.changeBg=function(t,e){return void 0===e&&(e=0),i.__awaiter(this,void 0,void 0,(function(){var n,s=this;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,a.DrawUtils.loadImage("assets/png/".concat(t,".png"))];case 1:return n=i.sent(),this.imageB=n,[4,(0,r.tweenValue)(0,1,e,r.EaseFuncs.easeInQuad,(function(t){return s.fade=t}))];case 2:return i.sent(),this.imageA=n,this.imageB=null,this.fade=0,[2]}}))}))},t.prototype.fadeIn=function(t,e){return void 0===e&&(e=0),i.__awaiter(this,void 0,void 0,(function(){var n,s=this;return i.__generator(this,(function(i){switch(i.label){case 0:return t?(n=this,[4,a.DrawUtils.loadImage("assets/png/".concat(t,".png"))]):[2];case 1:return n.imageA=i.sent(),this.fade=0,[4,(0,r.tweenValue)(this.overlayAlpha,0,e,r.EaseFuncs.easeInQuad,(function(t){return s.overlayAlpha=t}))];case 2:return i.sent(),[2]}}))}))},t.prototype.showOverlay=function(t,e,n){return void 0===t&&(t="#fff"),void 0===e&&(e=.2),void 0===n&&(n=0),i.__awaiter(this,void 0,void 0,(function(){var a=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.overlayColor=t,[4,(0,r.tweenValue)(this.overlayAlpha,e,n,r.EaseFuncs.easeOutCubic,(function(t){return a.overlayAlpha=t}))];case 1:return i.sent(),[2]}}))}))},t.prototype.hideOverlay=function(t){return void 0===t&&(t=0),i.__awaiter(this,void 0,void 0,(function(){var e=this;return i.__generator(this,(function(n){switch(n.label){case 0:return[4,(0,r.tweenValue)(this.overlayAlpha,0,t,r.EaseFuncs.easeInCubic,(function(t){return e.overlayAlpha=t}))];case 1:return n.sent(),[2]}}))}))},t}();e.Background=s},330:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Costume=void 0;var i=n(655),r=n(679),a=n(100),s=n(593),o=function(t){function e(){var e=t.call(this)||this;return e.width=.33,e}return i.__extends(e,t),e.prototype.drawBox=function(t,e,n,i,r){t.fillStyle="#fff",t.fillRect(e,n,i,r),t.strokeStyle="#000",t.lineWidth=.003*t.canvas.height,t.strokeRect(e,n,i,r)},e.prototype.show=function(e,n,r,a){return void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=0),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){switch(i.label){case 0:return this.x=r,this.y=a,[4,t.prototype.show.call(this,e,n)];case 1:return i.sent(),[2]}}))}))},e}(a.SpeechBox),u=function(){function t(){this.image=null,this.x=0,this.flipped=!1,this.alpha=1,this.align="left",this.bubble=new o}return Object.defineProperty(t.prototype,"actorId",{get:function(){var t;return null===(t=this.actor)||void 0===t?void 0:t.id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this.alpha>0},enumerable:!1,configurable:!0}),t.prototype.draw=function(t){if(this.image){var e=.6*t.canvas.height/this.image.height,n=t.canvas.width*this.x;t.translate(n,.7*t.canvas.height),t.scale(e*(this.flipped?-1:1),e),t.translate(-this.image.width/2,-this.image.height/2),t.globalAlpha=this.alpha,t.drawImage(this.image,0,0),t.resetTransform(),this.bubble.draw(t),t.globalAlpha=1}},t.prototype.enter=function(t,e){return void 0===e&&(e=0),i.__awaiter(this,void 0,void 0,(function(){var n,a=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.align=t.pos,this.x="left"===this.align?-.25:1.25,this.alpha=0,n=this,[4,s.DrawUtils.loadImage("assets/png/".concat(t.img,".png"))];case 1:return n.image=i.sent(),this.flipped=t.flipped,this.actor=t,(0,r.tweenValue)(0,1,e,r.EaseFuncs.easeInCubic,(function(t){return a.alpha=t})),[4,(0,r.tweenValue)(this.x,"left"===this.align?.2:.8,e,r.EaseFuncs.easeOutCubic,(function(t){return a.x=t}))];case 2:return i.sent(),[2]}}))}))},t.prototype.showBubble=function(t){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){switch(e.label){case 0:return[4,this.bubble.show(t,1e3,"left"===this.align?.1:.56,.33)];case 1:return e.sent(),[2]}}))}))},t.prototype.hideBubble=function(){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(t){switch(t.label){case 0:return[4,this.bubble.hide(1e3)];case 1:return t.sent(),[2]}}))}))},t.prototype.exit=function(t){return void 0===t&&(t=0),i.__awaiter(this,void 0,void 0,(function(){var e=this;return i.__generator(this,(function(n){switch(n.label){case 0:return(0,r.tweenValue)(this.alpha,0,t,r.EaseFuncs.easeInCubic,(function(t){return e.alpha=t})),[4,(0,r.tweenValue)(this.x,"left"===this.align?-.25:1.25,t,r.EaseFuncs.easeOutCubic,(function(t){return e.x=t}))];case 1:return n.sent(),this.actor,[2]}}))}))},t}();e.Costume=u},434:function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Directive=void 0;var n=function(){function t(t){this.operations=[],this.parameters={},this.text="",this.innerReg=/([^\s"':]+):"([^"]+)"|([^\s"':]+):'([^']+)'|([^\s"':]+):([^\s]+)|([^\s"':]+)/gm,this.parse(t)}return t.prototype.parse=function(t){for(var e,n,i,r,a,s,o;null!==(o=this.innerReg.exec(t));){var u=null!==(i=null!==(n=null!==(e=o[1])&&void 0!==e?e:o[3])&&void 0!==n?n:o[5])&&void 0!==i?i:null,l=null!==(s=null!==(a=null!==(r=o[2])&&void 0!==r?r:o[4])&&void 0!==a?a:o[6])&&void 0!==s?s:o[7];if(!l)throw new Error("Malformed directive "+t);u?this.parameters[u]=l:this.command?this.operations.push(l):this.command=l}},t}();e.Directive=n},629:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.InkLine=void 0;var i=n(434),r=function(){function t(t){this.text="",this.speaker="",this.directives=[],this.outerReg=/@\(([^\)]+)\)/gm,this.parse(t)}return Object.defineProperty(t.prototype,"hasText",{get:function(){return this.text&&""!==this.text},enumerable:!1,configurable:!0}),t.prototype.parse=function(t){for(var e;null!==(e=this.outerReg.exec(t));){if(!e[1])throw new Error("Malformed directive in line: "+t);this.directives.push(new i.Directive(e[1]))}this.text=t.replace(this.outerReg,"").trim();var n=this.text.split(":");n.length>1&&(this.speaker=n[0],this.text=n[1])},t}();e.InkLine=r},907:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Paragraph=void 0;var i=n(655),r=function(){function t(){this._text="",this._font="serif",this._lineHeight=.05,this._width=1,this.color="#000",this.dirty=!0,this.x=0,this.y=0,this.canvasWidth=-1,this.canvasHeight=-1,this.align="left"}return Object.defineProperty(t.prototype,"text",{get:function(){return this._text},set:function(t){this._text=t,this.dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t,this.dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(t){this._lineHeight=t,this.dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t,this.dirty=!0},enumerable:!1,configurable:!0}),t.prototype.getPixelHeight=function(t){return this.update(t),this.lineHeight*this.canvasHeight*this.lines.length},t.prototype.getHeight=function(t){return this.getPixelHeight(t)/this.canvasHeight},t.prototype.getPixelWidth=function(t){return this.update(t),this.lines.reduce((function(t,e){return e.width>t?e.width:t}),0)},t.prototype.getWidth=function(t){return this.getPixelWidth(t)/this.canvasWidth},t.prototype.update=function(t){t.font="".concat(this.lineHeight*t.canvas.height,"px ").concat(this.font),t.fillStyle=this.color,t.textBaseline="top",(this.dirty||this.canvasWidth!==t.canvas.width||this.canvasHeight!==t.canvas.height)&&(this.canvasWidth=t.canvas.width,this.canvasHeight=t.canvas.height,this.lines=this.getLines(t,this.text,this.width*this.canvasWidth),this.dirty=!1)},t.prototype.draw=function(t){var e,n;if(this.text&&""!==this.text){this.update(t);var r=this.y*this.canvasHeight;try{for(var a=i.__values(this.lines),s=a.next();!s.done;s=a.next()){var o=s.value,u="left"===this.align?0:"center"===this.align?(this.width*this.canvasWidth-o.width)/2:this.width*this.canvasWidth-o.width;t.fillText(o.text,this.x*this.canvasWidth+u,r),r+=this.lineHeight*this.canvasHeight}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}}},t.prototype.getLines=function(t,e,n){for(var i=e.split(" "),r=[],a=i[0],s=0,o=1;o<i.length;o++){var u=i[o],l=t.measureText(a+" "+u).width;l<n?a+=" "+u:(r.push({text:a,width:s}),a=u),s=l,o===i.length-1&&(s=t.measureText(a).width)}return 1===i.length&&(s=t.measureText(a).width),r.push({text:a,width:s}),r},t}();e.Paragraph=r},100:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SpeechBox=void 0;var i=n(655),r=n(679),a=n(907),s=function(){function t(){this.alpha=1,this.x=0,this.y=0,this.width=1;var t=new a.Paragraph;t.font="PatrickHand",t.lineHeight=.035,this.paragraph=t}return t.prototype.draw=function(t){if(this.text&&""!=this.text&&0!==this.alpha){this.paragraph.x=this.x+.01,this.paragraph.y=this.x+.01,this.paragraph.width=this.width-.02;var e=this.paragraph.getPixelHeight(t)+.02*t.canvas.height,n=this.paragraph.getPixelWidth(t)+.02*t.canvas.width,i=this.x*t.canvas.width,r=this.y*t.canvas.height;t.globalAlpha=this.alpha,this.drawBox(t,i,r,n,e),this.paragraph.draw(t),t.globalAlpha=1}},Object.defineProperty(t.prototype,"text",{get:function(){return this.paragraph.text},set:function(t){this.paragraph.text=t},enumerable:!1,configurable:!0}),t.prototype.show=function(t,e){return void 0===e&&(e=0),i.__awaiter(this,void 0,void 0,(function(){var n=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.text&&""!==this.text&&0!==this.alpha?[4,this.hide(.5*e)]:[3,2];case 1:i.sent(),e*=.5,i.label=2;case 2:return this.alpha=0,this.text=t,[4,(0,r.tweenValue)(this.alpha,1,e,r.EaseFuncs.easeOutQuad,(function(t){return n.alpha=t}))];case 3:return i.sent(),console.log("Showing..."),[2]}}))}))},t.prototype.hide=function(t){return void 0===t&&(t=0),i.__awaiter(this,void 0,void 0,(function(){var e=this;return i.__generator(this,(function(n){switch(n.label){case 0:return[4,(0,r.tweenValue)(this.alpha,0,t,r.EaseFuncs.easeOutQuad,(function(t){return e.alpha=t}))];case 1:return n.sent(),[2]}}))}))},t}();e.SpeechBox=s},757:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Title=void 0;var i=n(655),r=n(679),a=function(){function t(){this.title="",this.subtitle="",this.titleAlpha=1,this.subtitleAlpha=1,this.titleStyle="bold",this.titleFont="serif",this.titleHeight=.15,this.titleColor="#ffffffff",this.subtitleColor="#fff",this.shadowColor="#000",this.subtitleHeight=.07,this.subtitleFont="serif",this.subtitleStyle="",this.underlineWidth=.8,this.underlineColor="#a00",this.y=.5}return t.prototype.draw=function(t){t.textAlign="center";var e=t.canvas.width,n=t.canvas.height;this.title&&""!==this.title&&this.titleAlpha>0&&(t.globalAlpha=this.titleAlpha,t.font="".concat(this.titleStyle," ").concat(this.titleHeight*n,"px ").concat(this.titleFont),t.shadowBlur=this.titleHeight*n*.08,t.shadowColor=this.shadowColor,t.fillStyle=this.titleColor,t.fillText(this.title,e/2,n*this.y),t.shadowBlur=0,t.fillStyle=this.underlineColor,t.fillRect(e*((1-this.underlineWidth)/2),(this.y+.03)*n,this.underlineWidth*e,.01*n)),this.subtitle&&""!==this.subtitle&&this.subtitleAlpha>0&&(t.globalAlpha=this.subtitleAlpha,t.font="".concat(this.subtitleStyle," ").concat(this.subtitleHeight*n,"px ").concat(this.subtitleFont),t.shadowBlur=this.subtitleHeight*n*.08,t.shadowColor=this.shadowColor,t.fillStyle=this.subtitleColor,t.fillText(this.subtitle,e/2,n*(this.y+.13)),t.shadowBlur=0),t.globalAlpha=1,t.textAlign="start"},t.prototype.show=function(t,e,n){return void 0===e&&(e=null),void 0===n&&(n=0),i.__awaiter(this,void 0,void 0,(function(){var a=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.y=.5,this.titleAlpha=0,this.subtitleAlpha=0,this.subtitle=e,this.title=t,this.underlineWidth=0,(0,r.tweenValue)(0,1,.4*n,r.EaseFuncs.easeInCubic,(function(t){return a.titleAlpha=t})),[4,(0,r.tweenValue)(0,.8,.5*n,r.EaseFuncs.linear,(function(t){return a.underlineWidth=t}))];case 1:return i.sent(),null==this.subtitle?[3,4]:[4,(0,r.tweenValue)(this.y,this.y-.1,.2*n,r.EaseFuncs.easeOutCubic,(function(t){return a.y=t}))];case 2:return i.sent(),[4,(0,r.tweenValue)(0,1,.3*n,r.EaseFuncs.easeInCubic,(function(t){return a.subtitleAlpha=t}))];case 3:i.sent(),i.label=4;case 4:return[2]}}))}))},t.prototype.hide=function(t){return void 0===t&&(t=0),i.__awaiter(this,void 0,void 0,(function(){var e=this;return i.__generator(this,(function(n){switch(n.label){case 0:return(0,r.tweenValue)(this.titleAlpha,0,t,r.EaseFuncs.easeOutCubic,(function(t){return e.titleAlpha=t})),[4,(0,r.tweenValue)(this.subtitleAlpha,0,t,r.EaseFuncs.easeOutCubic,(function(t){return e.subtitleAlpha=t}))];case 1:return n.sent(),this.title=null,[2]}}))}))},t}();e.Title=a},695:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Voiceover=void 0;var i=n(655),r=function(t){function e(){var e=t.call(this)||this;return e.width=.66,e.x=.02,e.y=.02,e}return i.__extends(e,t),e.prototype.drawBox=function(t,e,n,i,r){t.fillStyle="rgba(255, 246, 79, 0.8)",t.fillRect(e,n,i,r),t.strokeStyle="#000",t.lineWidth=.003*t.canvas.height,t.strokeRect(e,n,i,r)},e}(n(100).SpeechBox);e.Voiceover=r},346:function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SPEEDUP=void 0,e.SPEEDUP=!1,addEventListener("keydown",(function(t){"q"===t.key&&(e.SPEEDUP=!0)})),addEventListener("keyup",(function(t){"q"===t.key&&(e.SPEEDUP=!1)}))},679:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.tweenValue=e.EaseFuncs=void 0;var i,r=n(346);(i=e.EaseFuncs||(e.EaseFuncs={})).linear=function(t,e,n,i){return t*e/n+i},i.easeInQuad=function(t,e,n,i){return t*(e/=n)*e+i},i.easeOutQuad=function(t,e,n,i){return-t*(e/=n)*(e-2)+i},i.easeInOutQuad=function(t,e,n,i){return(e/=n/2)<1?t/2*e*e+i:-t/2*(--e*(e-2)-1)+i},i.easeInCubic=function(t,e,n,i){return t*(e/=n)*e*e+i},i.easeOutCubic=function(t,e,n,i){return t*((e=e/n-1)*e*e+1)+i},i.easeInOutCubic=function(t,e,n,i){return(e/=n/2)<1?t/2*e*e*e+i:t/2*((e-=2)*e*e+2)+i},e.tweenValue=function(t,e,n,i,a){if(r.SPEEDUP)return a(e),Promise.resolve();var s,o=e-t,u=0,l=-1,h=function(r){-1===l&&(l=r);var c=i(o,u=r-l,n,t);u>=n?(a(e),s()):(a(c),requestAnimationFrame(h))};return new Promise((function(t,e){s=t,requestAnimationFrame(h)}))}},593:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DrawUtils=e.TimeUtils=e.InputUtils=void 0;var i=n(655),r=n(346),a=function(){function t(){}return t.waitForEvent=function(t,e,n){return void 0===e&&(e=window),new Promise((function(e,i){var r=function(i){n&&!n(i)||(e(i),removeEventListener(t,r))};addEventListener(t,r)}))},t.waitKey=function(e){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(n){switch(n.label){case 0:return[4,t.waitForEvent("keydown",window,(function(t){return!e||-1!=e.findIndex((function(e){return e===t.key}))}))];case 1:return[2,n.sent().key]}}))}))},t.waitClick=function(e){return t.waitForEvent("click",e)},t}();e.InputUtils=a;var s=function(){function t(){}return t.wait=function(t){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){return r.SPEEDUP?[2,Promise.resolve()]:[2,new Promise((function(e,n){var i=-1,r=function(n){-1===i&&(i=n),n-i>=t?e():requestAnimationFrame(r)};requestAnimationFrame(r)}))]}))}))},t}();e.TimeUtils=s;var o=function(){function t(){}return t.drawFullScreenImage=function(t,e){var n,i,r=t.canvas.width/e.width,a=t.canvas.height/e.height;r>a?(n=t.canvas.width,i=e.height*r):(i=t.canvas.height,n=e.width*a),t.drawImage(e,-(n-t.canvas.width)/2-.01*n,-(i-t.canvas.height)/2-.01*i,1.02*n,1.02*i)},t.loadImage=function(t){return i.__awaiter(this,void 0,void 0,(function(){var e;return i.__generator(this,(function(n){switch(n.label){case 0:return e=createImageBitmap,[4,fetch(t)];case 1:return[4,n.sent().blob()];case 2:return[4,e.apply(void 0,[n.sent()])];case 3:return[2,n.sent()]}}))}))},t}();e.DrawUtils=o},655:function(t,e,n){"use strict";n.r(e),n.d(e,{__assign:function(){return a},__asyncDelegator:function(){return b},__asyncGenerator:function(){return S},__asyncValues:function(){return w},__await:function(){return g},__awaiter:function(){return h},__classPrivateFieldGet:function(){return E},__classPrivateFieldSet:function(){return T},__createBinding:function(){return f},__decorate:function(){return o},__exportStar:function(){return v},__extends:function(){return r},__generator:function(){return c},__importDefault:function(){return _},__importStar:function(){return C},__makeTemplateObject:function(){return k},__metadata:function(){return l},__param:function(){return u},__read:function(){return p},__rest:function(){return s},__spread:function(){return y},__spreadArrays:function(){return m},__values:function(){return d}});var i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},i(t,e)};function r(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var a=function(){return a=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},a.apply(this,arguments)};function s(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(n[i[r]]=t[i[r]])}return n}function o(t,e,n,i){var r,a=arguments.length,s=a<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,i);else for(var o=t.length-1;o>=0;o--)(r=t[o])&&(s=(a<3?r(s):a>3?r(e,n,s):r(e,n))||s);return a>3&&s&&Object.defineProperty(e,n,s),s}function u(t,e){return function(n,i){e(n,i,t)}}function l(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function h(t,e,n,i){return new(n||(n=Promise))((function(r,a){function s(t){try{u(i.next(t))}catch(t){a(t)}}function o(t){try{u(i.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,o)}u((i=i.apply(t,e||[])).next())}))}function c(t,e){var n,i,r,a,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&a[0]?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,i=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],i=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}function f(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]}function v(t,e){for(var n in t)"default"===n||e.hasOwnProperty(n)||(e[n]=t[n])}function d(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],i=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function p(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,a=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=a.next()).done;)s.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return s}function y(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(p(arguments[e]));return t}function m(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),r=0;for(e=0;e<n;e++)for(var a=arguments[e],s=0,o=a.length;s<o;s++,r++)i[r]=a[s];return i}function g(t){return this instanceof g?(this.v=t,this):new g(t)}function S(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,r=n.apply(t,e||[]),a=[];return i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i;function s(t){r[t]&&(i[t]=function(e){return new Promise((function(n,i){a.push([t,e,n,i])>1||o(t,e)}))})}function o(t,e){try{(n=r[t](e)).value instanceof g?Promise.resolve(n.value.v).then(u,l):h(a[0][2],n)}catch(t){h(a[0][3],t)}var n}function u(t){o("next",t)}function l(t){o("throw",t)}function h(t,e){t(e),a.shift(),a.length&&o(a[0][0],a[0][1])}}function b(t){var e,n;return e={},i("next"),i("throw",(function(t){throw t})),i("return"),e[Symbol.iterator]=function(){return this},e;function i(i,r){e[i]=t[i]?function(e){return(n=!n)?{value:g(t[i](e)),done:"return"===i}:r?r(e):e}:r}}function w(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,n=t[Symbol.asyncIterator];return n?n.call(t):(t=d(t),e={},i("next"),i("throw"),i("return"),e[Symbol.asyncIterator]=function(){return this},e);function i(n){e[n]=t[n]&&function(e){return new Promise((function(i,r){!function(t,e,n,i){Promise.resolve(i).then((function(e){t({value:e,done:n})}),e)}(i,r,(e=t[n](e)).done,e.value)}))}}}function k(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t}function C(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function _(t){return t&&t.__esModule?t:{default:t}}function E(t,e){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return e.get(t)}function T(t,e,n){if(!e.has(t))throw new TypeError("attempted to set private field on non-instance");return e.set(t,n),n}}},e={};function n(i){var r=e[i];if(void 0!==r)return r.exports;var a=e[i]={exports:{}};return t[i].call(a.exports,a,a.exports,n),a.exports}n.d=function(t,e){for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},function(){"use strict";var t,e=n(655),i=n(802),r=n(679),a=n(117),s=n(593),o=n(61),u=n(330),l=n(757),h=n(695),c=n(629),f=n(907),v=n(272),d=null!==(t=window.kanvas)&&void 0!==t?t:document.getElementById("canvas"),p=function(){function t(t){this.story=new a.Story(t),this.globalTags=this.decodeTags(this.story.globalTags)}return t.prototype.getTags=function(){return this.decodeTags(this.story.currentTags)},t.prototype.decodeTags=function(t){var n,i,r={};try{for(var a=e.__values(t),s=a.next();!s.done;s=a.next()){var o=s.value.split(":");o.length>1?r[o[0].trim()]=o[1].trim():r[o[0].trim()]=!0}}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}return r},t}(),y=function(){function t(t){this.directive=t}return t.prototype.executeOperations=function(){var t=this,n=this.getDefaults(),i=this.loadParameters(),r=e.__assign(e.__assign({},n),i);return 0===this.directive.operations.length?this.executeOperation("default",r):Promise.all(this.directive.operations.map((function(e){return t.executeOperation(e,r)})))},t.prototype.tryConvertParameter=function(t,e){this.directive.parameters[t]&&(this.directive.parameters[t]=e(this.directive.parameters[t]))},t}(),m=function(t){function n(e,n,i,r){var a=t.call(this,e)||this;return a.renderer=n,a.defaults={title:i,subtitle:r,time:1e3},a}return e.__extends(n,t),n.prototype.loadParameters=function(){return this.tryConvertParameter("time",(function(t){return parseInt(t)})),this.directive.parameters},n.prototype.getDefaults=function(){return this.defaults},n.prototype.executeOperation=function(t,e){switch(t){case"show":return this.renderer.show(e.title,e.subtitle,e.time);case"hide":return this.renderer.hide(e.time);default:throw new Error("Unknown operation: "+t)}},n}(y),g=function(t){function n(e,n,i,r){var a=t.call(this,e)||this;return a.actor=n,a.costumeLeft=i,a.costumeRight=r,a}return e.__extends(n,t),n.prototype.loadParameters=function(){return this.tryConvertParameter("flipped",(function(t){return"true"===t})),this.directive.parameters},n.prototype.getDefaults=function(){return this.actor},n.prototype.executeOperation=function(t,n){return e.__awaiter(this,void 0,void 0,(function(){var i;return e.__generator(this,(function(e){switch(e.label){case 0:switch(t){case"set":return[3,1];case"enter":return[3,2];case"exit":return[3,6]}return[3,8];case 1:return Object.assign(this.actor,n),[2,Promise.resolve()];case 2:return(i="right"===n.pos?this.costumeRight:this.costumeLeft).visible?[4,i.exit(.5*n.time)]:[3,4];case 3:e.sent(),n.time*=.5,e.label=4;case 4:return[4,i.enter(n,n.time)];case 5:return e.sent(),[2];case 6:return(i="right"===n.pos?this.costumeRight:this.costumeLeft).visible?[4,i.exit(n.time)]:[3,8];case 7:e.sent(),e.label=8;case 8:throw new Error("Unknown operation: "+t)}}))}))},n}(y),S=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return e.__extends(n,t),n.prototype.loadParameters=function(){var t;return this.tryConvertParameter("seconds",(function(t){return parseFloat(t)})),this.tryConvertParameter("time",(function(t){return parseInt(t)})),{time:null!==(t=this.directive.parameters.time)&&void 0!==t?t:1e3*this.directive.parameters.seconds}},n.prototype.getDefaults=function(){return{time:1e3}},n.prototype.executeOperation=function(t,e){return s.TimeUtils.wait(e.time)},n}(y),b=function(t){function n(e,n){var i=t.call(this,e)||this;return i.renderer=n,i}return e.__extends(n,t),n.prototype.loadParameters=function(){return this.directive.parameters},n.prototype.getDefaults=function(){return{time:1e3}},n.prototype.executeOperation=function(t,e){if("fade-in"===t)return this.renderer.fadeIn(e.img,e.time);throw new Error("Unknown operation: "+t)},n}(y),w=function(){function t(t,e,n){var i=this;this.canvas=t,this.id=e,this.paragraph=new f.Paragraph,this.handler=function(t){return i.handleInput(t)},this.x=0,this.y=0,this.alpha=1,this.boundingBox=[0,0,0,0],this.state="inactive",this.color="rgba(255,255,255,0.6)",this.paragraph.text=n,this.paragraph.font="PatrickHand"}return t.prototype.draw=function(t){if(this.alpha>0){var e=this.paragraph.getPixelWidth(t)+.02*t.canvas.width,n=this.paragraph.getPixelHeight(t)+.02*t.canvas.height;this.paragraph.x=this.x,this.paragraph.y=this.y;var i=t.canvas.width*(this.x-.01),r=t.canvas.height*(this.y-.01);t.translate(-e/2,-n/2),t.globalAlpha=this.alpha,t.fillStyle=this.color,t.fillRect(i,r,e,n),t.strokeStyle="#000",t.lineWidth=.003*t.canvas.height,t.strokeRect(i,r,e,n),this.paragraph.draw(t),t.globalAlpha=1,t.translate(e/2,n/2),this.boundingBox=[i-e/2,r-n/2,e,n]}},t.prototype.registerObserver=function(t){this.observer=t},t.prototype.isInside=function(t,n){var i=e.__read(this.boundingBox,4),r=i[0],a=i[1],s=i[2],o=i[3];return t>=r&&n>=a&&t<r+s&&n<a+o},t.prototype.handleInput=function(t){switch(this.state){case"inactive":return this.color="rgba(255,255,255,0.6)",void(this.isInside(t.offsetX,t.offsetY)&&(this.state="mouseover"));case"mouseover":return this.color="#fff",this.isInside(t.offsetX,t.offsetY)?"mousedown"===t.type&&0===t.button?(this.state="active",void(this.color="rgba(255, 246, 79, 1)")):void 0:void(this.state="inactive");case"active":return this.color="rgba(255, 246, 79, 1)",this.isInside(t.offsetX,t.offsetY)?"mouseup"===t.type&&0===t.button?(this.observer(this.id),void(this.state="mouseover")):void 0:void(this.state="inactive")}},t.prototype.show=function(t,n,i){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),e.__awaiter(this,void 0,void 0,(function(){var a=this;return e.__generator(this,(function(e){switch(e.label){case 0:return this.x=t,this.y=n,this.alpha=0,[4,(0,r.tweenValue)(0,1,i,r.EaseFuncs.easeInQuad,(function(t){return a.alpha=t}))];case 1:return e.sent(),d.addEventListener("mousemove",this.handler),d.addEventListener("mousedown",this.handler),d.addEventListener("mouseup",this.handler),[2]}}))}))},t.prototype.hide=function(t){return void 0===t&&(t=0),e.__awaiter(this,void 0,void 0,(function(){var n=this;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(0,r.tweenValue)(this.alpha,0,t,r.EaseFuncs.easeInQuad,(function(t){return n.alpha=t}))];case 1:return e.sent(),d.removeEventListener("mousemove",this.handler),d.removeEventListener("mousedown",this.handler),d.removeEventListener("mouseup",this.handler),[2]}}))}))},t}(),k=function(){function t(t){this.canvas=t,this.options=[]}return t.prototype.draw=function(t){var n,i;try{for(var r=e.__values(this.options),a=r.next();!a.done;a=r.next())a.value.draw(t)}catch(t){n={error:t}}finally{try{a&&!a.done&&(i=r.return)&&i.call(r)}finally{if(n)throw n.error}}},t.prototype.getChoice=function(t,n){return void 0===n&&(n=0),e.__awaiter(this,void 0,void 0,(function(){var i,r,a,s,o,u,l,h,c,f,v,d=this;return e.__generator(this,(function(p){switch(p.label){case 0:this.options=t.map((function(t){return new w(d.canvas,t.index,t.text)})),i=.5,r=.66,s=new Promise((function(t){return a=t})),p.label=1;case 1:p.trys.push([1,6,7,8]),o=e.__values(this.options),u=o.next(),p.label=2;case 2:return u.done?[3,5]:((l=u.value).registerObserver(a),[4,l.show(i,r,n/this.options.length)]);case 3:p.sent(),p.label=4;case 4:return u=o.next(),[3,2];case 5:return[3,8];case 6:return h=p.sent(),f={error:h},[3,8];case 7:try{u&&!u.done&&(v=o.return)&&v.call(o)}finally{if(f)throw f.error}return[7];case 8:return[4,s];case 9:return c=p.sent(),[4,this.hide(n)];case 10:return p.sent(),[2,c]}}))}))},t.prototype.hide=function(t){return void 0===t&&(t=0),e.__awaiter(this,void 0,void 0,(function(){var n,i,r,a,s;return e.__generator(this,(function(o){switch(o.label){case 0:o.trys.push([0,5,6,7]),n=e.__values(this.options),i=n.next(),o.label=1;case 1:return i.done?[3,4]:[4,i.value.hide(t/this.options.length)];case 2:o.sent(),o.label=3;case 3:return i=n.next(),[3,1];case 4:return[3,7];case 5:return r=o.sent(),a={error:r},[3,7];case 6:try{i&&!i.done&&(s=n.return)&&s.call(n)}finally{if(a)throw a.error}return[7];case 7:return this.options=[],[2]}}))}))},t}(),C=function(){function t(t){this.canvas=t,this.background=new o.Background,this.charLeft=new u.Costume,this.charRight=new u.Costume,this.title=new l.Title,this.voiceover=new h.Voiceover,this.actors={},this.textMode=null,this.ctx=t.getContext("2d"),this.choices=new k(t)}return t.prototype.draw=function(){this.background.draw(this.ctx),this.charLeft.draw(this.ctx),this.charRight.draw(this.ctx),this.voiceover.draw(this.ctx),this.choices.draw(this.ctx),this.title.draw(this.ctx)},t.prototype.clickOrKey=function(){return Promise.race([s.InputUtils.waitClick(this.canvas),s.InputUtils.waitKey()])},t.prototype.display=function(t,n){return e.__awaiter(this,void 0,void 0,(function(){var i,r;return e.__generator(this,(function(e){switch(e.label){case 0:return"VOICEOVER"!==n?[3,4]:[4,this.voiceover.show(t,1e3)];case 1:return e.sent(),this.lastText=this.voiceover,[4,this.clickOrKey()];case 2:return e.sent(),[4,this.voiceover.hide(1e3)];case 3:return e.sent(),[3,12];case 4:if(null!==(i=n===this.charLeft.actorId?this.charLeft:n===this.charRight.actorId?this.charRight:null))return[3,8];if(!(r=this.actors[n]))throw new Error("Unknown character: "+n);return(i="left"===r.pos?this.charLeft:this.charRight).actorId?[4,i.exit(1e3)]:[3,6];case 5:e.sent(),e.label=6;case 6:return[4,i.enter(r,1e3)];case 7:e.sent(),e.label=8;case 8:return[4,i.showBubble(t)];case 9:return e.sent(),[4,this.clickOrKey()];case 10:return e.sent(),[4,i.hideBubble()];case 11:e.sent(),e.label=12;case 12:return[2]}}))}))},t.prototype.executeDirective=function(t){return e.__awaiter(this,void 0,void 0,(function(){var n;return e.__generator(this,(function(e){if(t.command.toUpperCase()===t.command)return(n=this.actors[t.command])||(n=this.actors[t.command]=new v.Actor(t.command)),[2,new g(t,n,this.charLeft,this.charRight).executeOperations()];switch(t.command){case"title":return[2,new m(t,this.title,this.ink.globalTags.title,this.ink.globalTags.author).executeOperations()];case"wait":return[2,new S(t).executeOperations()];case"scene":return[2,new b(t,this.background).executeOperations()];default:throw new Error("Unknown directive: "+t.command)}return[2]}))}))},t.prototype.processLine=function(t){return e.__awaiter(this,void 0,void 0,(function(){var n=this;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,Promise.all(t.directives.map((function(t){return n.executeDirective(t)})))];case 1:return e.sent(),t.hasText?[4,this.display(t.text,t.speaker)]:[3,3];case 2:e.sent(),e.label=3;case 3:return[2]}}))}))},t.prototype.run=function(t){return e.__awaiter(this,void 0,void 0,(function(){var n,i,r;return e.__generator(this,(function(e){switch(e.label){case 0:return this.ink=new p(t),[4,this.background.showOverlay("#000",1)];case 1:e.sent(),e.label=2;case 2:if(!this.ink.story.canContinue)return[3,9];e.label=3;case 3:return this.ink.story.canContinue?(n=this.ink.story.Continue(),i=new c.InkLine(n),[4,this.processLine(i)]):[3,5];case 4:return e.sent(),[3,3];case 5:return this.ink.story.currentChoices.length>0?[4,this.choices.getChoice(this.ink.story.currentChoices,2e3)]:[3,7];case 6:return r=e.sent(),this.ink.story.ChooseChoiceIndex(r),[3,8];case 7:return[2];case 8:return[3,2];case 9:return[2]}}))}))},t}(),_=new C(d);requestAnimationFrame((function t(e){_.draw(),requestAnimationFrame(t)})),_.run(i.default).catch((function(t){return console.log(t.stack)}))}()}();
//# sourceMappingURL=example_ink.js.map